{"id":"benefit-market-09b","title":"UI/UX дизайн-система","description":"Дизайн-система проекта: цветовая палитра, типографика, компоненты shadcn/ui, макеты ключевых экранов. Должна быть готова до начала разработки UI.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-25T21:50:58.885888+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:19:49.399214+03:00","closed_at":"2026-02-25T22:19:49.399214+03:00","close_reason":"Дизайн-система полностью готова: spec + код"}
{"id":"benefit-market-09b.1","title":"Дизайн-спецификация: цветовая палитра и типографика","description":"Определить и задокументировать в docs/DESIGN.md:\n\n1. Цветовая палитра:\n   - Primary: основной цвет бренда (для кнопок, ссылок, акцентов).\n   - Secondary: дополнительный цвет.\n   - Semantic: success (зелёный), warning (жёлтый), error (красный), info (синий).\n   - Статусы заказов: reserved (amber), paid (emerald), cancelled (slate), expired (rose).\n   - Транзакции ledger: accrual (green), spend (red), reserve (amber), release (blue), expire (gray).\n   - Нейтральные: background, surface, border, muted, foreground.\n   - Тёмная тема: все цвета с dark mode вариантами.\n\n2. Типографика:\n   - Выбрать 2 Google Fonts: display (заголовки) + body (текст).\n   - НЕ Inter, НЕ Roboto, НЕ Arial — что-то с характером.\n   - Type scale: h1-h6, body-lg, body, body-sm, caption.\n   - Задокументировать font-weight для каждого уровня.\n\n3. CSS переменные и tailwind.config.ts расширение.\n\nAcceptance: файл docs/DESIGN.md с точными hex-кодами, CSS variables, Tailwind config snippet.","status":"closed","priority":0,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:58:01.577339+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:11:38.050563+03:00","closed_at":"2026-02-25T22:11:38.050563+03:00","close_reason":"Спецификация создана в docs/DESIGN.md (2047 строк)","dependencies":[{"issue_id":"benefit-market-09b.1","depends_on_id":"benefit-market-09b","type":"parent-child","created_at":"2026-02-25T21:58:01.58096+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-09b.2","title":"Дизайн-спецификация: компоненты и паттерны","description":"Описать визуальный дизайн ключевых компонентов:\n\n1. Sidebar Navigation — стиль (тёмный/светлый), иконки, active state, hover, collapsed (mobile).\n2. Header Bar — информация о пользователе, баланс баллов (pill badge), название компании.\n3. Benefit Card — для каталога: layout, иконка/изображение, название, цена в баллах (badge), категория (tag).\n4. Status Badge — цветовое кодирование для каждого статуса заказа.\n5. Wallet Balance — крупное отображение баллов, available/reserved/total.\n6. Transaction Row — иконка типа + сумма + цвет + описание.\n7. Data Table — стиль для HR/admin (zebra stripes?, header, sorting arrows, фильтры).\n8. Metric Card — большая цифра + label + опционально sparkline/trend arrow.\n9. Charts — стилизация recharts: цвета серий, tooltip, grid, legend.\n10. Form Inputs — border style, focus ring, validation (error/success), label placement.\n11. Buttons — primary, secondary, outline, ghost, destructive. Размеры: sm, md, lg.\n12. Toast — success/error/warning стили, анимация входа/выхода.\n13. Empty State — иллюстрация + сообщение + CTA кнопка.\n14. File Upload Zone — drag \u0026 drop area для CSV импорта.\n15. Modal/Dialog — overlay, размеры, анимация.\n\nДля каждого компонента: описание + какой shadcn/ui компонент в основе + кастомизация.\n\nAcceptance: секция в docs/DESIGN.md с описанием каждого компонента.","status":"closed","priority":0,"issue_type":"task","estimated_minutes":150,"created_at":"2026-02-25T21:58:06.774112+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:11:38.118668+03:00","closed_at":"2026-02-25T22:11:38.118668+03:00","close_reason":"Спецификация создана в docs/DESIGN.md (2047 строк)","dependencies":[{"issue_id":"benefit-market-09b.2","depends_on_id":"benefit-market-09b","type":"parent-child","created_at":"2026-02-25T21:58:06.775152+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-09b.3","title":"Дизайн-спецификация: layouts и wireframes ключевых экранов","description":"ASCII/текстовые wireframes для ключевых экранов:\n\nEMPLOYEE:\n1. Каталог льгот — grid 3 колонки (desktop), 1 колонка (mobile), поиск + фильтр сверху.\n2. Детальная страница льготы — hero + описание + sidebar с ценой и кнопкой.\n3. Корзина — список позиций + итого + кнопка оформления.\n4. Кошелёк — баланс card вверху + таблица транзакций.\n5. История заказов — таблица/список с фильтром.\n\nHR:\n6. Дашборд — 4 метрики вверху + 3 графика (bar, pie, line).\n7. Список сотрудников — таблица с поиском.\n8. Импорт CSV — зона загрузки + превью + результат.\n\nADMIN:\n9. CRUD таблица (универсальный паттерн) — header + фильтры + таблица + pagination.\n10. Форма создания/редактирования — модальное окно или drawer.\n\nДля каждого: описание layout, responsive поведение (desktop → tablet → mobile).\nSidebar: 256px desktop, overlay на mobile, иконки + labels.\n\nAcceptance: секция в docs/DESIGN.md с wireframes.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:58:13.071675+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:11:38.202707+03:00","closed_at":"2026-02-25T22:11:38.202707+03:00","close_reason":"Спецификация создана в docs/DESIGN.md (2047 строк)","dependencies":[{"issue_id":"benefit-market-09b.3","depends_on_id":"benefit-market-09b","type":"parent-child","created_at":"2026-02-25T21:58:13.072425+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-09b.3","depends_on_id":"benefit-market-09b.1","type":"blocks","created_at":"2026-02-25T22:04:58.395291+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-09b.4","title":"Настройка Tailwind + shadcn/ui theme","description":"Реализовать дизайн-систему в коде:\n\n1. tailwind.config.ts:\n   - Расширить colors с кастомной палитрой.\n   - Добавить fontFamily (Google Fonts).\n   - Настроить borderRadius, spacing если нужно.\n\n2. globals.css:\n   - CSS переменные для light/dark theme.\n   - @import Google Fonts.\n   - Базовые стили body, headings.\n\n3. shadcn/ui theme:\n   - components.json — настройка стиля (default или new-york).\n   - Кастомизация через CSS переменные (--primary, --secondary, --accent, etc).\n\n4. Добавить компоненты shadcn/ui которые понадобятся:\n   Card, Button, Input, Select, Table, Badge, Dialog, Sheet, Tabs, Skeleton, Toast, DropdownMenu, Avatar, Tooltip.\n\nAcceptance: запускается npm run dev, тема применяется корректно, dark mode переключается.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":180,"created_at":"2026-02-25T21:58:14.727558+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:19:49.180568+03:00","closed_at":"2026-02-25T22:19:49.180568+03:00","close_reason":"Tailwind + shadcn/ui + дизайн-система настроены, 26 компонентов установлены","dependencies":[{"issue_id":"benefit-market-09b.4","depends_on_id":"benefit-market-09b","type":"parent-child","created_at":"2026-02-25T21:58:14.728262+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-09b.4","depends_on_id":"benefit-market-09b.1","type":"blocks","created_at":"2026-02-25T22:04:58.622887+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-09b.4","depends_on_id":"benefit-market-09b.2","type":"blocks","created_at":"2026-02-25T22:04:58.866914+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-0cf","title":"4.2 Create admin categories page","description":"## 4.2 Create admin categories page\n\n### Файл\n`src/app/dashboard/admin/categories/page.tsx` (CREATE)\n\n### Что сделать\nCRUD страница по паттерну admin/benefits (файл admin/benefits/page.tsx):\n1. Таблица: Название, Иконка, Порядок сортировки\n2. Кнопка 'Добавить категорию' → Dialog с формой (name, icon, sort_order)\n3. Кнопка редактирования в каждой строке → тот же Dialog\n4. Кнопка удаления в каждой строке (с подтверждением)\n5. Loading state, empty state\n6. Fetch /api/admin/categories, POST/PATCH/DELETE\n\n### Компоненты (по паттерну admin/benefits)\nTable, Dialog, Button, Input, Label, Loader2, Pencil, Plus, Trash2, toast\n\n### Верификация\n- Создание категории через диалог\n- Редактирование существующей\n- Удаление с подтверждением\n- Обновление таблицы после CRUD операций","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-25T23:54:28.906781+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:06:31.500936+03:00","closed_at":"2026-02-26T00:06:31.500936+03:00","close_reason":"Closed"}
{"id":"benefit-market-0ea","title":"Epic 12: Security","description":"## Epic 12: Security\n\n### Задачи (параллельно с Epic 9-10)\n1. **Input sanitization** — `src/lib/api/sanitize.ts`: escapeIlike() для SQL ilike queries\n2. **Rate limiting** — `src/lib/api/rate-limiter.ts` + middleware: in-memory rate limiter\n3. **Security headers** — next.config.ts: CSP, X-Frame-Options, X-Content-Type-Options и пр.\n4. **Demo credentials isolation** — dynamic import demo credentials, не включать в production bundle\n\n### Верификация\n- ilike injection не работает\n- Rate limit возвращает 429\n- Security headers в response\n- Demo credentials не в production bundle","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-25T23:54:53.290026+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:42:48.91258+03:00","closed_at":"2026-02-26T00:42:48.91258+03:00","close_reason":"escapeIlike sanitization for 2 ilike queries, in-memory rate limiter, 6 security headers in next.config.ts. Build passes.","dependencies":[{"issue_id":"benefit-market-0ea","depends_on_id":"benefit-market-1is","type":"blocks","created_at":"2026-02-25T23:59:27.504596+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-0sh","title":"Frontend: портал провайдера (все страницы)","description":"Полный фронтенд провайдерского портала.\n\nLAYOUT:\n- src/app/dashboard/provider/layout.tsx — layout с sidebar\n- Навигация (добавить в app-sidebar.tsx):\n  - Dashboard (LayoutDashboard)\n  - Предложения (Package)\n  - Заказы (ClipboardList)\n  - Аналитика (BarChart)\n  - Профиль (Building2)\n\nСТРАНИЦЫ:\n1. src/app/dashboard/provider/page.tsx — Dashboard\n   - Карточки метрик: активные предложения, заказы за месяц, средний рейтинг, кол-во подключений\n   - График заказов за 6 месяцев\n   - Последние заказы (таблица)\n   - Предложения требующие внимания (draft без submit)\n\n2. src/app/dashboard/provider/offerings/page.tsx — Список предложений\n   - Таблица: название, категория, цена, статус, рейтинг, заказы\n   - Фильтр по статусу (draft/pending/published/archived)\n   - Кнопка 'Новое предложение'\n   - Inline-действия: Submit for review, Archive\n\n3. src/app/dashboard/provider/offerings/new/page.tsx — Создание предложения\n   - Форма: название, описание, подробное описание (rich text или textarea)\n   - Категория (select из global_categories)\n   - Цена в баллах, лимит стока\n   - Загрузка изображений (URL или upload)\n   - Условия использования, информация о доставке\n   - Кнопки: Сохранить черновик / Отправить на модерацию\n\n4. src/app/dashboard/provider/offerings/[id]/page.tsx — Редактирование\n   - Та же форма + текущий статус\n   - Если draft: кнопка Submit\n   - Если published: предупреждение об изменениях\n\n5. src/app/dashboard/provider/orders/page.tsx — Заказы\n   - Таблица: ID, предложение, компания (анонимизированная), кол-во, баллы, статус, дата\n   - Фильтры: статус, предложение, дата\n   - Нет действий (провайдер не может менять статус заказа)\n\n6. src/app/dashboard/provider/analytics/page.tsx — Аналитика\n   - Графики (Recharts):\n     - Заказы по месяцам\n     - Распределение по предложениям (pie chart)\n     - Рейтинг по предложениям\n   - Метрики: конверсия просмотры→заказы, средний чек\n\n7. src/app/dashboard/provider/profile/page.tsx — Профиль компании\n   - Просмотр/редактирование: название, описание, лого, сайт, контакты\n   - Статус верификации (read-only)\n   - Если pending: сообщение 'Ожидает проверки'\n\nДИЗАЙН:\n- Следовать существующему дизайну (shadcn/ui, тёплые цвета, Source Serif + DM Sans)\n- Переиспользовать: metric-card, data-table-pagination, empty-state, skeletons","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T08:59:58.055872+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:27:16.843513+03:00","closed_at":"2026-02-27T09:27:16.843513+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-0sh","depends_on_id":"benefit-market-itu","type":"blocks","created_at":"2026-02-27T09:00:43.462074+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-0sh","depends_on_id":"benefit-market-onf","type":"blocks","created_at":"2026-02-27T09:00:43.702232+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-1a0","title":"Админ-панель и полировка","description":"Недели 7-8. Управление tenant'ами, каталогом, политиками и правилами. Аудит-лог, сгорание баллов (expiration cron), UI-полировка, адаптивность.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-02-25T21:50:55.004791+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:46:12.793112+03:00","closed_at":"2026-02-25T22:46:12.793112+03:00","close_reason":"Epic 4 полностью готов","dependencies":[{"issue_id":"benefit-market-1a0","depends_on_id":"benefit-market-94r","type":"blocks","created_at":"2026-02-25T21:55:13.317979+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-1a0.1","title":"API + UI: Управление tenant'ами","description":"Страница /dashboard/admin/tenants:\n\nAPI:\n- GET /api/admin/tenants — список tenant'ов с пагинацией.\n- POST /api/admin/tenants — создание нового tenant'а.\n- PATCH /api/admin/tenants/:id — обновление настроек.\n\nUI:\n- Таблица tenant'ов: название, домен, количество сотрудников, дата создания.\n- Модальное окно создания: name, domain, settings.\n- Редактирование в drawer/modal.\n- Доступ: только admin.","status":"closed","priority":2,"issue_type":"task","estimated_minutes":150,"created_at":"2026-02-25T21:54:19.377647+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:46:12.138952+03:00","closed_at":"2026-02-25T22:46:12.138952+03:00","close_reason":"Admin API (12 routes) + UI (6 pages) + pagination + audit log реализованы","dependencies":[{"issue_id":"benefit-market-1a0.1","depends_on_id":"benefit-market-1a0","type":"parent-child","created_at":"2026-02-25T21:54:19.378363+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-1a0.2","title":"API + UI: CRUD каталога льгот (админ)","description":"Страница /dashboard/admin/benefits:\n\nAPI:\n- GET /api/admin/benefits — все льготы (включая неактивные).\n- POST /api/admin/benefits — создание.\n- PATCH /api/admin/benefits/:id — обновление (название, цена, лимит, is_active).\n- DELETE /api/admin/benefits/:id — soft delete (is_active=false).\n- CRUD для benefit_categories.\n\nUI:\n- Таблица: название, категория, цена баллов, лимит, статус (вкл/выкл).\n- Toggle для is_active прямо в таблице.\n- Форма создания/редактирования: все поля + выбор категории.\n- Фильтр по категории и статусу.","status":"closed","priority":2,"issue_type":"task","estimated_minutes":180,"created_at":"2026-02-25T21:54:22.060993+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:46:12.198802+03:00","closed_at":"2026-02-25T22:46:12.198802+03:00","close_reason":"Admin API (12 routes) + UI (6 pages) + pagination + audit log реализованы","dependencies":[{"issue_id":"benefit-market-1a0.2","depends_on_id":"benefit-market-1a0","type":"parent-child","created_at":"2026-02-25T21:54:22.061618+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-1a0.3","title":"API + UI: CRUD budget policies","description":"Страница /dashboard/admin/policies:\n\nAPI:\n- GET /api/admin/policies — все политики tenant'а.\n- POST /api/admin/policies — создание.\n- PATCH /api/admin/policies/:id — обновление.\n- DELETE /api/admin/policies/:id — деактивация.\n\nUI:\n- Таблица: название, баллов, период, фильтр целевой группы, статус.\n- Форма: name, points_amount (числовой input), period (select: monthly/quarterly/yearly), target_filter (визуальный конструктор условий: grade, location, legal_entity — multi-select для каждого), is_active.\n- Предпросмотр: 'Попадает N сотрудников из M'.","status":"closed","priority":2,"issue_type":"task","estimated_minutes":150,"created_at":"2026-02-25T21:54:24.489911+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:46:12.262635+03:00","closed_at":"2026-02-25T22:46:12.262635+03:00","close_reason":"Admin API (12 routes) + UI (6 pages) + pagination + audit log реализованы","dependencies":[{"issue_id":"benefit-market-1a0.3","depends_on_id":"benefit-market-1a0","type":"parent-child","created_at":"2026-02-25T21:54:24.490552+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-1a0.4","title":"API + UI: CRUD eligibility rules","description":"Страница /dashboard/admin/rules (или inline в карточке льготы):\n\nAPI:\n- GET /api/admin/rules?benefit_id= — правила для льготы.\n- POST /api/admin/rules — создание.\n- PATCH /api/admin/rules/:id — обновление.\n- DELETE /api/admin/rules/:id — удаление.\n\nUI:\n- Конструктор условий: grade (multi-select), min_tenure (number), location (multi-select), legal_entity (multi-select).\n- Привязка к конкретной льготе (benefit_id).\n- Предпросмотр: 'Льгота доступна N из M сотрудников'.\n- Можно встроить прямо в форму редактирования льготы.","status":"closed","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:54:27.067449+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:46:12.32834+03:00","closed_at":"2026-02-25T22:46:12.32834+03:00","close_reason":"Admin API (12 routes) + UI (6 pages) + pagination + audit log реализованы","dependencies":[{"issue_id":"benefit-market-1a0.4","depends_on_id":"benefit-market-1a0","type":"parent-child","created_at":"2026-02-25T21:54:27.068031+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-1a0.5","title":"API + UI: Управление пользователями и ролями","description":"Страница /dashboard/admin/users:\n\nAPI:\n- GET /api/admin/users — пользователи tenant'а с профилями.\n- PATCH /api/admin/users/:id — изменение роли.\n- POST /api/admin/users/invite — пригласить (создать запись + отправить email, или в MVP просто создать).\n\nUI:\n- Таблица: email, имя, роль, tenant, дата регистрации.\n- Быстрое изменение роли через select в строке.\n- Фильтр по роли и tenant'у.\n- Поиск по email/имени.","status":"closed","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:54:31.357871+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:46:12.387293+03:00","closed_at":"2026-02-25T22:46:12.387293+03:00","close_reason":"Admin API (12 routes) + UI (6 pages) + pagination + audit log реализованы","dependencies":[{"issue_id":"benefit-market-1a0.5","depends_on_id":"benefit-market-1a0","type":"parent-child","created_at":"2026-02-25T21:54:31.358471+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-1a0.6","title":"API + UI: Аудит-лог","description":"Страница /dashboard/admin/audit:\n\nAPI:\n- GET /api/admin/audit-log — записи с пагинацией, фильтрацией.\n  Query: ?entity_type=, ?action=, ?user_id=, ?from=, ?to=, ?page=\n\nUI:\n- Таблица: дата/время, пользователь, действие, сущность, diff (expandable row).\n- Фильтры: по типу сущности, по действию, по дате.\n- diff показывать в формате 'было → стало' (JSON diff viewer).\n\nЗапись в audit_log — через database trigger или helper в API routes.","status":"closed","priority":3,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:54:32.479088+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:46:12.448488+03:00","closed_at":"2026-02-25T22:46:12.448488+03:00","close_reason":"Admin API (12 routes) + UI (6 pages) + pagination + audit log реализованы","dependencies":[{"issue_id":"benefit-market-1a0.6","depends_on_id":"benefit-market-1a0","type":"parent-child","created_at":"2026-02-25T21:54:32.479732+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-1a0.7","title":"Edge Function: Сгорание баллов (expiration cron)","description":"Supabase Edge Function + cron:\n\nЗапускается раз в день (00:05).\n\nАлгоритм:\n1. SELECT * FROM wallets WHERE expires_at \u003c now() AND balance \u003e 0.\n2. Для каждого expired wallet:\n   a. INSERT INTO point_ledger type='expire', amount = -balance.\n   b. UPDATE wallets SET balance = 0, reserved = 0.\n3. Логирование: количество expired кошельков, сумма сгоревших баллов.\n\nТест: создать wallet с expires_at в прошлом, запустить функцию, проверить ledger и balance.","status":"closed","priority":2,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-25T21:54:33.849103+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:46:12.508423+03:00","closed_at":"2026-02-25T22:46:12.508423+03:00","close_reason":"Admin API (12 routes) + UI (6 pages) + pagination + audit log реализованы","dependencies":[{"issue_id":"benefit-market-1a0.7","depends_on_id":"benefit-market-1a0","type":"parent-child","created_at":"2026-02-25T21:54:33.849926+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-1a0.8","title":"UI-полировка: адаптивность, ошибки, пустые состояния","description":"Финальная полировка UI:\n\n1. Адаптивность: все страницы корректно отображаются на 320px-1920px.\n2. Пустые состояния: иконка + текст + CTA для каждого списка (нет заказов, нет льгот, нет сотрудников).\n3. Обработка ошибок: toast-уведомления для API-ошибок, Error Boundary для компонентов.\n4. Loading states: skeleton для всех списков и карточек.\n5. 404 страница.\n6. Toast для успешных действий (заказ создан, импорт завершён).\n7. Confirmation dialogs для деструктивных действий.\n\nshadcn/ui: Toast, AlertDialog, Skeleton.","status":"closed","priority":3,"issue_type":"task","estimated_minutes":180,"created_at":"2026-02-25T21:54:36.584431+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:46:12.570396+03:00","closed_at":"2026-02-25T22:46:12.570396+03:00","close_reason":"Admin API (12 routes) + UI (6 pages) + pagination + audit log реализованы","dependencies":[{"issue_id":"benefit-market-1a0.8","depends_on_id":"benefit-market-1a0","type":"parent-child","created_at":"2026-02-25T21:54:36.585057+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-1d6","title":"Epic 10: Frontend Polish","description":"## Epic 10: Frontend Polish\n\n### Задачи\n1. **Loading skeletons** — CatalogSkeleton, TablePageSkeleton, DetailPageSkeleton (заменить 'Loading...' текст)\n2. **Stock limit validation in cart store** — не позволять добавить больше stock_limit\n3. **Accessibility** — aria-labels, landmark roles, keyboard nav, focus-visible, skip-to-content link\n\n### Зависимости\nЗависит от Epic 9 (React Query hooks для loading states)\n\n### Верификация\n- Skeleton states вместо 'Loading...'\n- stock_limit проверяется при addItem/updateQuantity\n- axe-core audit без critical/serious violations","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-25T23:54:50.068726+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:45:02.787671+03:00","closed_at":"2026-02-26T00:45:02.787671+03:00","close_reason":"Skeleton components created (CatalogSkeleton, TablePageSkeleton, DetailPageSkeleton). Stock_limit validation in cart store addItem/updateQuantity. Skip-to-content link, main landmark role, aria-labels on skeletons. Build passes.","dependencies":[{"issue_id":"benefit-market-1d6","depends_on_id":"benefit-market-93m","type":"blocks","created_at":"2026-02-25T23:59:26.991227+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-1is","title":"Epic 6: Type Safety and Auth Foundation","description":"## Epic 6: Foundation — Type Safety \u0026 Auth\n\n### Контекст\nКодовая база содержит 40x `as unknown as`, 27x `as never`, ~400 строк дублированного auth-бойлерплейта в 22 API routes. Это затрудняет поддержку, увеличивает риск ошибок и делает рефакторинг опасным.\n\n### Задачи\n1. **Env validation** — `src/lib/env.ts` (CREATE): Zod-схемы для server/client env variables. Runtime validation при старте.\n2. **Typed errors** — `src/lib/errors.ts` (CREATE): AppError class + factory functions (unauthorized, forbidden, notFound, validation, dbError).\n3. **API response helpers** — `src/lib/api/response.ts` (CREATE): success(), error(), withErrorHandling() HOF для routes.\n4. **Shared auth middleware** — `src/lib/api/auth.ts` (CREATE): requireAuth() и requireRole() — возвращают appUser или бросают typed error.\n5. **Typed Supabase queries** — `src/lib/supabase/typed-queries.ts` (CREATE): типизированные обёртки для Supabase CRUD без as unknown as.\n6. **Refactor all 22 API routes** — убрать все as unknown as, as never, заменить auth boilerplate на shared middleware.\n\n### Верификация\n- `npx tsc --noEmit` — 0 ошибок\n- `grep -r 'as unknown as' src/` = 0 результатов\n- `grep -r 'as never' src/` = 0 результатов\n- Все API routes работают как прежде\n- Каждый route \u003c 80 строк","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-25T23:54:43.607075+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:21:06.477083+03:00","closed_at":"2026-02-26T00:21:06.477083+03:00","close_reason":"All 22 API routes refactored. 0 'as unknown as' casts in routes. as never kept for Supabase insert/update. Build passes."}
{"id":"benefit-market-1z2","title":"Epic 7: Business Logic and Demo Isolation","description":"## Epic 7: Foundation — Business Logic \u0026 Demo Isolation\n\n### Контекст\nДублированная логика условий в eligibility.ts и budget.ts. Demo mode чеки (NEXT_PUBLIC_DEMO_MODE) разбросаны по 14 файлам с копипастой. Нет структурированного логирования.\n\n### Задачи\n1. **Shared condition evaluator** — `src/lib/domain/condition-evaluator.ts` (CREATE): извлечь общую логику из eligibility.ts и budget.ts.\n2. **Demo mode centralization**:\n   - `src/lib/api/demo-handler.ts` (CREATE): withDemoFallback() HOF\n   - `src/lib/demo/demo-service.ts` (CREATE): централизованный доступ к demo-данным по entity type\n   - Рефакторинг 14 файлов с demo-чеками\n3. **Structured logger** — `src/lib/logger.ts` (CREATE): JSON-based logger с уровнями, context, timestamp.\n\n### Верификация\n- Demo mode работает во всех routes\n- `grep 'NEXT_PUBLIC_DEMO_MODE' src/app/api/` = 0 (вся логика в demo-handler)\n- Eligibility и budget используют shared evaluator\n- Логгер используется вместо console.error","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-25T23:54:45.205403+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:28:33.744335+03:00","closed_at":"2026-02-26T00:28:33.744335+03:00","close_reason":"Shared condition-evaluator created, eligibility.ts and budget.ts deduplicated. Demo-service centralized complex demo responses for 7 routes. Logger replaces all console.error. Build passes."}
{"id":"benefit-market-2ns","title":"EPIC: AI-рекомендации льгот","description":"Персональные рекомендации на основе профиля сотрудника (грейд, стаж, локация, поведение). Модели: collaborative filtering (сотрудники как вы выбирают...), content-based (на основе ваших предпочтений), популярность в компании. Цель: +15-25% вовлечённости. Ни один конкурент в РФ этого не делает.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-27T08:36:33.786408+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:28:43.490217+03:00","closed_at":"2026-02-27T09:28:43.490217+03:00","close_reason":"Отклонено — collaborative filtering неэффективен без данных о семье/здоровье/геолокации, popularity слишком примитивна. Хороший поиск и фильтры в каталоге достаточны."}
{"id":"benefit-market-2ns.1","title":"Данные для AI-рекомендаций: события и профиль пользователя","description":"Создать инфраструктуру для сбора данных, необходимых AI-рекомендациям.\n\nНОВАЯ ТАБЛИЦА user_events (аналитические события):\n- id, user_id (FK→users), tenant_id (FK→tenants)\n- event_type: 'view_offering' | 'add_to_cart' | 'order' | 'review' | 'search' | 'category_browse'\n- target_type: 'provider_offering' | 'tenant_offering' | 'benefit' | 'category'\n- target_id (uuid)\n- metadata (jsonb) — доп. данные (search query, время на странице и тд)\n- created_at\n- Индексы: (user_id, event_type), (tenant_id, target_id), (created_at)\n- RLS: пользователь видит свои, HR/admin видит всех в тенанте\n\nНОВАЯ ТАБЛИЦА user_preferences:\n- id, user_id (FK→users, UNIQUE), tenant_id (FK→tenants)\n- preferred_categories (uuid[]) — выбранные категории интересов\n- budget_preference: 'save' | 'spend_all' | 'balanced'\n- interests (text[]) — теги интересов (спорт, обучение, здоровье)\n- onboarding_completed (boolean)\n- updated_at\n- RLS: пользователь видит/редактирует свои\n\nAPI для трекинга событий:\n- POST /api/events — записать событие (requireAuth, rate-limit)\n\nAPI для предпочтений:\n- GET /api/preferences — получить свои\n- PUT /api/preferences — обновить (при онбординге и позже)\n\nUI: Онбординг-визард при первом входе:\n- 'Какие категории вам интересны?' (мультиселект категорий)\n- 'Как вы планируете тратить баллы?' (экономить / тратить всё / баланс)\n\nФайлы:\n- supabase/migrations/00005_recommendation_data.sql\n- src/app/api/events/route.ts\n- src/app/api/preferences/route.ts\n- src/components/onboarding/preferences-wizard.tsx\n- src/lib/hooks/useTrackEvent.ts — хук для трекинга из UI\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T09:14:42.430925+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:28:43.548268+03:00","closed_at":"2026-02-27T09:28:43.548268+03:00","close_reason":"Отклонено — collaborative filtering неэффективен без данных о семье/здоровье/геолокации, popularity слишком примитивна. Хороший поиск и фильтры в каталоге достаточны.","dependencies":[{"issue_id":"benefit-market-2ns.1","depends_on_id":"benefit-market-2ns","type":"parent-child","created_at":"2026-02-27T09:14:42.431608+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-2ns.1","depends_on_id":"benefit-market-6b1","type":"blocks","created_at":"2026-02-27T09:15:07.232364+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-2ns.2","title":"Движок AI-рекомендаций (backend logic)","description":"Реализовать серверную логику рекомендаций. Три стратегии ранжирования, комбинируемые по весам.\n\nСТРАТЕГИИ:\n1. Collaborative filtering (простой вариант):\n   - Найти пользователей в том же тенанте с похожим профилем (грейд, отдел, стаж)\n   - Посмотреть что они заказывали\n   - Рекомендовать то, что текущий пользователь ещё не заказывал\n   - SQL: SELECT по order_items JOIN users JOIN employee_profiles, GROUP BY offering, ORDER BY count DESC\n\n2. Content-based:\n   - На основе user_preferences.preferred_categories и interests\n   - Предложения из предпочитаемых категорий ранжировать выше\n   - Учитывать рейтинг предложения (avg_rating)\n\n3. Popularity (fallback):\n   - Самые популярные предложения в тенанте за последние 30 дней\n   - По количеству заказов + средний рейтинг\n   - Используется для новых пользователей (cold start)\n\nКОМБИНИРОВАНИЕ:\n- Для нового пользователя (нет заказов): 70% popularity + 30% content-based\n- Для активного (есть заказы): 50% collaborative + 30% content-based + 20% popularity\n- Результат: список offering_id с score, отсортированный по score DESC\n\nAPI:\n- GET /api/recommendations — рекомендации для текущего пользователя\n  - Параметры: limit (default 6), exclude_ordered (default true)\n  - Ответ: { recommendations: [{ offering, score, reason: 'Коллеги из вашего отдела выбирают' | 'На основе ваших интересов' | 'Популярно в компании' }] }\n\nСЕРВИС:\n- src/lib/services/recommendation.service.ts:\n  - getRecommendations(userId, tenantId, limit): Promise\u003cRecommendation[]\u003e\n  - getSimilarUsers(userId, tenantId): Promise\u003cstring[]\u003e\n  - getPopularOfferings(tenantId, days, limit): Promise\u003cScoredOffering[]\u003e\n  - getCategoryBasedOfferings(preferences, tenantId): Promise\u003cScoredOffering[]\u003e\n  - combineAndRank(strategies, weights): ScoredOffering[]\n\nКЭШИРОВАНИЕ:\n- Рекомендации кэшировать на 1 час (или до следующего заказа)\n- Простое решение: jsonb колонка user_recommendations в user_preferences или отдельная таблица\n\nФайлы:\n- src/lib/services/recommendation.service.ts\n- src/app/api/recommendations/route.ts\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T09:14:49.004605+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:28:43.60454+03:00","closed_at":"2026-02-27T09:28:43.60454+03:00","close_reason":"Отклонено — collaborative filtering неэффективен без данных о семье/здоровье/геолокации, popularity слишком примитивна. Хороший поиск и фильтры в каталоге достаточны.","dependencies":[{"issue_id":"benefit-market-2ns.2","depends_on_id":"benefit-market-2ns","type":"parent-child","created_at":"2026-02-27T09:14:49.005291+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-2ns.2","depends_on_id":"benefit-market-2ns.1","type":"blocks","created_at":"2026-02-27T09:14:58.832959+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-2ns.3","title":"UI: блок рекомендаций в каталоге и дашборде","description":"Фронтенд для отображения AI-рекомендаций.\n\nКОМПОНЕНТЫ:\n1. src/components/recommendations/recommendation-carousel.tsx\n   - Горизонтальная карусель 'Рекомендовано для вас'\n   - Карточки с: лого провайдера, название, цена, рейтинг, reason ('Популярно в компании')\n   - Кнопка 'В корзину'\n   - Скелетон при загрузке\n   - Пустое состояние: 'Заполните предпочтения для персональных рекомендаций'\n\n2. src/components/recommendations/recommendation-reason.tsx\n   - Бейдж-пояснение: 'Ваши коллеги выбирают', 'На основе ваших интересов', 'Топ в компании'\n   - Разные цвета/иконки для каждого типа\n\nИНТЕГРАЦИЯ:\n- src/app/dashboard/employee/page.tsx (главная):\n  - Секция 'Рекомендовано для вас' перед основным контентом\n  - Показывать 4-6 рекомендаций\n\n- src/app/dashboard/employee/catalog/page.tsx:\n  - Секция 'Рекомендовано для вас' в начале каталога\n  - При пустом поиске показывать рекомендации первыми\n\nТРЕКИНГ:\n- При показе рекомендации: POST /api/events { type: 'view_recommendation', target_id }\n- При клике: POST /api/events { type: 'click_recommendation', target_id }\n- Это даёт данные для улучшения качества рекомендаций\n\nФайлы:\n- src/components/recommendations/recommendation-carousel.tsx\n- src/components/recommendations/recommendation-reason.tsx\n- src/app/dashboard/employee/page.tsx (обновить)\n- src/app/dashboard/employee/catalog/page.tsx (обновить)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-27T09:14:53.826351+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:28:43.663342+03:00","closed_at":"2026-02-27T09:28:43.663342+03:00","close_reason":"Отклонено — collaborative filtering неэффективен без данных о семье/здоровье/геолокации, popularity слишком примитивна. Хороший поиск и фильтры в каталоге достаточны.","dependencies":[{"issue_id":"benefit-market-2ns.3","depends_on_id":"benefit-market-2ns","type":"parent-child","created_at":"2026-02-27T09:14:53.827122+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-2ns.3","depends_on_id":"benefit-market-2ns.2","type":"blocks","created_at":"2026-02-27T09:15:02.895052+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-3o1","title":"Обновить навигацию sidebar для маркетплейса","description":"Обновить src/components/layout/app-sidebar.tsx для поддержки маркетплейса.\n\nДОБАВИТЬ ПУНКТЫ:\n1. Provider nav (role=provider):\n   - Dashboard → /dashboard/provider (LayoutDashboard)\n   - Предложения → /dashboard/provider/offerings (Package)\n   - Заказы → /dashboard/provider/orders (ClipboardList)\n   - Аналитика → /dashboard/provider/analytics (BarChart)\n   - Профиль → /dashboard/provider/profile (Building2)\n\n2. HR nav — добавить:\n   - Маркетплейс → /dashboard/hr/marketplace (Store)\n   - Подключённые → /dashboard/hr/offerings (Package)\n\n3. Admin nav — добавить:\n   - Провайдеры → /dashboard/admin/providers (Building2)\n   - Модерация → /dashboard/admin/offerings (ShieldCheck)\n   - Глобальные категории → /dashboard/admin/global-categories (Tags)\n\nЛогика:\n- На основе user role показывать нужный набор навигации\n- Проверить что существующая навигация не сломалась","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T09:00:07.231618+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:27:16.914491+03:00","closed_at":"2026-02-27T09:27:16.914491+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-3o1","depends_on_id":"benefit-market-cm7","type":"blocks","created_at":"2026-02-27T09:00:43.926298+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-4e5","title":"EPIC: White-label кастомизация для компаний","description":"Компании-клиенты стилизуют платформу под себя: логотип, цвета, кастомные карточки в каталоге, приветственное сообщение, кастомный домен. Ощущение своей платформы. Провайдеры тоже могут брендировать свои карточки.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-27T08:36:42.26626+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:23:13.463215+03:00","closed_at":"2026-02-27T09:23:13.463215+03:00","close_reason":"Отклонено — white-label не нужен"}
{"id":"benefit-market-4e5.1","title":"Backend: настройки брендирования тенанта","description":"Расширить настройки тенанта для хранения брендинг-конфигурации.\n\nИЗМЕНЕНИЯ В ТАБЛИЦЕ tenants:\n- Расширить settings (jsonb) или создать отдельную таблицу tenant_branding:\n  - id, tenant_id (FK, UNIQUE)\n  - logo_url (text) — логотип компании\n  - favicon_url (text)\n  - primary_color (text) — hex (#FF6B35)\n  - secondary_color (text) — hex\n  - accent_color (text) — hex\n  - background_color (text) — hex (для светлой темы)\n  - dark_background_color (text) — hex (для тёмной темы)\n  - font_heading (text) — шрифт заголовков (из списка доступных)\n  - font_body (text) — шрифт текста\n  - welcome_title (text) — заголовок приветствия ('Добро пожаловать в Льготы ТехФьючер!')\n  - welcome_message (text) — текст приветствия\n  - custom_css (text) — кастомный CSS (ограниченный набор переменных)\n  - created_at, updated_at\n\nРЕШЕНИЕ: Лучше отдельная таблица tenant_branding — чище и не засоряет jsonb settings.\n\nRLS: HR/admin CRUD, employee SELECT для своего тенанта.\n\nAPI:\n- GET /api/tenant/branding — получить брендинг текущего тенанта\n- PUT /api/tenant/branding — обновить (requireRole hr/admin)\n\nВалидация:\n- Цвета: regex hex (#000000-#FFFFFF)\n- Шрифты: enum из разрешённого списка (Source Serif Pro, DM Sans, Inter, Montserrat, Roboto, PT Sans, PT Serif)\n- logo_url: valid URL\n- custom_css: sanitization (только CSS-переменные, без JS)\n\nФайлы:\n- supabase/migrations/00007_tenant_branding.sql\n- src/app/api/tenant/branding/route.ts\n- src/lib/api/validators.ts (добавить brandingSchema)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-27T09:15:53.892325+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:23:13.532026+03:00","closed_at":"2026-02-27T09:23:13.532026+03:00","close_reason":"Отклонено — white-label не нужен","dependencies":[{"issue_id":"benefit-market-4e5.1","depends_on_id":"benefit-market-4e5","type":"parent-child","created_at":"2026-02-27T09:15:53.893675+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-4e5.2","title":"Frontend: применение брендинга тенанта","description":"Система применения кастомного брендинга на фронтенде.\n\nПОДХОД: CSS Custom Properties (переменные)\n\n1. src/lib/hooks/useTenantBranding.ts\n   - Хук загружает branding из API (с кэшированием)\n   - Применяет CSS-переменные на document.documentElement:\n     --tenant-primary, --tenant-secondary, --tenant-accent\n     --tenant-bg, --tenant-dark-bg\n     --tenant-font-heading, --tenant-font-body\n   - Fallback: дефолтные значения платформы\n\n2. src/components/layout/tenant-branding-provider.tsx\n   - Context provider, оборачивает layout\n   - Загружает branding при маунте\n   - Предоставляет контекст с данными брендинга\n\n3. Обновить компоненты для использования CSS-переменных:\n   - app-sidebar.tsx: лого компании вместо дефолтного\n   - Заголовки: шрифт из --tenant-font-heading\n   - Кнопки accent: цвет из --tenant-primary\n   - Карточки: border-color из --tenant-accent\n\n4. src/app/dashboard/employee/page.tsx:\n   - Welcome-блок с кастомным заголовком и сообщением\n   - Лого компании\n\n5. Поддержка тёмной темы:\n   - dark:--tenant-bg → --tenant-dark-bg\n   - Автоматический расчёт контрастных цветов\n\nОГРАНИЧЕНИЯ:\n- Только цвета и шрифты, НЕ layout\n- CSS-переменные безопасны (не могут выполнить код)\n- Fallback всегда на дефолт платформы\n\nФайлы:\n- src/lib/hooks/useTenantBranding.ts\n- src/components/layout/tenant-branding-provider.tsx\n- src/app/globals.css (добавить CSS-переменные)\n- src/app/dashboard/employee/page.tsx (обновить welcome)\n- src/components/layout/app-sidebar.tsx (обновить лого)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-27T09:15:58.26543+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:23:13.601609+03:00","closed_at":"2026-02-27T09:23:13.601609+03:00","close_reason":"Отклонено — white-label не нужен","dependencies":[{"issue_id":"benefit-market-4e5.2","depends_on_id":"benefit-market-4e5","type":"parent-child","created_at":"2026-02-27T09:15:58.26616+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-4e5.2","depends_on_id":"benefit-market-4e5.1","type":"blocks","created_at":"2026-02-27T09:16:13.108809+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-4e5.3","title":"HR-панель: настройка брендинга компании","description":"Страница настроек брендинга для HR/admin.\n\nСТРАНИЦА: src/app/dashboard/hr/branding/page.tsx\n\nСЕКЦИИ:\n1. Логотип\n   - Загрузка лого (URL или drag-n-drop upload)\n   - Preview текущего лого\n   - Рекомендуемый размер: 200x60px, PNG/SVG\n\n2. Цветовая схема\n   - Color picker для: primary, secondary, accent\n   - Preset-схемы: 'Корпоративный синий', 'Тёплый оранжевый', 'Зелёный', 'Фиолетовый'\n   - Live preview: мини-превью карточки с текущими цветами\n\n3. Шрифты\n   - Dropdown для заголовков (из списка)\n   - Dropdown для текста (из списка)\n   - Preview текста с выбранным шрифтом\n\n4. Приветствие\n   - Текстовое поле: заголовок приветствия\n   - Textarea: сообщение приветствия\n   - Preview как будет выглядеть\n\n5. Live Preview\n   - Справа или внизу — мини-превью дашборда с применёнными стилями\n   - Обновляется в реальном времени при изменении настроек\n\nКНОПКИ: Сохранить / Сбросить к умолчанию\n\nДобавить в навигацию HR: 'Брендирование' → /dashboard/hr/branding (Palette icon)\n\nФайлы:\n- src/app/dashboard/hr/branding/page.tsx\n- src/components/branding/color-picker.tsx\n- src/components/branding/font-selector.tsx\n- src/components/branding/branding-preview.tsx\n- src/components/layout/app-sidebar.tsx (добавить пункт навигации)\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-27T09:16:02.691594+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:23:13.682863+03:00","closed_at":"2026-02-27T09:23:13.682863+03:00","close_reason":"Отклонено — white-label не нужен","dependencies":[{"issue_id":"benefit-market-4e5.3","depends_on_id":"benefit-market-4e5","type":"parent-child","created_at":"2026-02-27T09:16:02.692315+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-4e5.3","depends_on_id":"benefit-market-4e5.1","type":"blocks","created_at":"2026-02-27T09:16:17.334114+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-4e5.3","depends_on_id":"benefit-market-4e5.2","type":"blocks","created_at":"2026-02-27T09:16:17.575326+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-4op","title":"4.3 Add Categories to admin sidebar","description":"## 4.3 Add Categories to admin sidebar\n\n### Файл\n`src/components/layout/app-sidebar.tsx`\n\n### Текущее состояние\nadminNavItems содержит: Компании, Каталог, Политики, Правила, Пользователи, Аудит. Нет пункта 'Категории'.\n\n### Что сделать\nДобавить в массив adminNavItems:\n```typescript\n{ title: 'Категории', href: '/dashboard/admin/categories', icon: FolderOpen }\n```\nИмпортировать FolderOpen из lucide-react. Расположить после 'Каталог' (Package).\n\n### Верификация\n- Пункт 'Категории' виден в admin sidebar\n- Клик → переход на /dashboard/admin/categories\n- Active state работает","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-25T23:54:30.603185+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:06:31.56003+03:00","closed_at":"2026-02-26T00:06:31.56003+03:00","close_reason":"Closed"}
{"id":"benefit-market-5bu","title":"API: регистрация и профиль провайдера","description":"Создать API-роуты для провайдерского портала — регистрация и профиль.\n\nРОУТЫ:\n1. POST /api/provider/register — регистрация профиля провайдера\n   - Требует role=provider (requireRole('provider'))\n   - Валидация: registerProviderSchema\n   - Создаёт запись в providers (status=pending)\n   - Создаёт запись в provider_users (role=owner)\n   - Возвращает созданный профиль\n   - Проверка: у пользователя ещё нет провайдера\n\n2. GET /api/provider/profile — получить свой профиль\n   - Требует role=provider\n   - Ищет providers по owner_user_id = current user\n   - Возвращает профиль с количеством предложений\n\n3. PATCH /api/provider/profile — обновить профиль\n   - Требует role=provider\n   - Валидация: updateProviderSchema\n   - Нельзя менять status, verified_at, slug\n   - Аудит-лог изменений\n\nФайлы:\n- src/app/api/provider/register/route.ts\n- src/app/api/provider/profile/route.ts\n\nХелпер: getProviderForUser(supabase, userId) — получить провайдера по user_id. Добавить в src/lib/services/provider.service.ts\n\nПаттерн: withErrorHandling() + requireRole() как в src/app/api/admin/benefits/route.ts","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T08:57:59.604796+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:17:40.698474+03:00","closed_at":"2026-02-27T09:17:40.698474+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-5bu","depends_on_id":"benefit-market-cm7","type":"blocks","created_at":"2026-02-27T09:00:36.757501+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-5bu","depends_on_id":"benefit-market-mxo","type":"blocks","created_at":"2026-02-27T09:00:37.010123+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-5p6","title":"EPIC: Аналитика и данные — инсайты для HR и бизнеса","description":"Максимально глубокое понимание кто/что хочет. Предиктивная аналитика для HR: прогноз утилизации, корреляция льгот с текучкой, рекомендации по каталогу. Аналитика wellbeing: eNPS, удовлетворённость, анонимные опросы. Бенчмаркинг по отраслям. Данные — самая ценная часть продукта.","status":"open","priority":1,"issue_type":"feature","created_at":"2026-02-27T08:36:37.361311+03:00","created_by":"ayugunin","updated_at":"2026-02-27T08:36:37.361311+03:00"}
{"id":"benefit-market-5p6.1","title":"HR-аналитика: дашборд использования льгот","description":"Расширенная аналитика для HR по использованию льгот в компании.\n\nAPI:\n1. GET /api/hr/analytics/utilization — утилизация бюджета\n   - Общий бюджет компании vs потраченный (% и абсолют)\n   - По отделам: какой отдел тратит больше/меньше\n   - По грейдам: распределение трат по грейдам\n   - Тренд: утилизация по месяцам за 12 мес\n   - Данные: из wallets + point_ledger + employee_profiles\n\n2. GET /api/hr/analytics/popular — популярные льготы\n   - Топ-10 по количеству заказов\n   - Топ-10 по сумме баллов\n   - Рост/падение vs предыдущий период\n   - Данные: из orders + order_items + benefits/tenant_offerings\n\n3. GET /api/hr/analytics/engagement — вовлечённость\n   - % сотрудников, сделавших хотя бы 1 заказ\n   - % сотрудников, не использовавших баллы вообще\n   - Средний чек\n   - Частота заказов (заказов/сотрудник/месяц)\n   - По отделам\n\n4. GET /api/hr/analytics/categories — по категориям\n   - Распределение трат по категориям (pie chart)\n   - Динамика по категориям (stacked bar chart)\n\nUI СТРАНИЦА: src/app/dashboard/hr/analytics/page.tsx\n- Метрики-карточки вверху: утилизация %, активных сотрудников, средний чек, заказов в месяц\n- Графики (Recharts):\n  - Line chart: утилизация по месяцам\n  - Bar chart: топ-10 льгот\n  - Pie chart: распределение по категориям\n  - Bar chart: вовлечённость по отделам\n- Фильтры: период (месяц/квартал/год), отдел, грейд\n- Экспорт в CSV\n\nФайлы:\n- src/app/api/hr/analytics/utilization/route.ts\n- src/app/api/hr/analytics/popular/route.ts\n- src/app/api/hr/analytics/engagement/route.ts\n- src/app/api/hr/analytics/categories/route.ts\n- src/app/dashboard/hr/analytics/page.tsx\n- src/components/analytics/utilization-chart.tsx\n- src/components/analytics/popular-benefits-chart.tsx\n- src/components/analytics/engagement-chart.tsx\n- src/components/analytics/category-distribution.tsx","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-27T09:14:57.122273+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:14:57.122273+03:00","dependencies":[{"issue_id":"benefit-market-5p6.1","depends_on_id":"benefit-market-5p6","type":"parent-child","created_at":"2026-02-27T09:14:57.123646+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-5p6.2","title":"Предиктивная аналитика для HR","description":"Умные инсайты и прогнозы на основе данных использования.\n\nAPI:\n1. GET /api/hr/analytics/predictions — прогнозы\n   - Прогноз утилизации на конец периода: \"К концу квартала будет использовано ~75% бюджета\"\n   - Метод: линейная экстраполяция текущего тренда (простой, но эффективный)\n   - Предупреждения: \"В отделе разработки 40% бюджета не использовано. Средний по компании: 15%\"\n\n2. GET /api/hr/analytics/insights — автоматические инсайты\n   - Генерировать на основе правил:\n     a) \"Категория Образование выросла на 40% vs прошлый квартал\"\n     b) \"Новые сотрудники (стаж \u003c 6 мес) используют на 60% меньше баллов\"\n     c) \"5 сотрудников не сделали ни одного заказа за 3 месяца\"\n     d) \"Предложение X имеет рейтинг ниже 3.0 — рассмотрите замену\"\n   - Каждый инсайт: { type, severity: info|warning|action, title, description, metric }\n\n3. GET /api/hr/analytics/benchmarks — бенчмаркинг\n   - Сравнение с анонимизированными данными по платформе:\n     \"Ваша утилизация 72% — среднее по платформе 65%\"\n     \"Ваш средний рейтинг провайдеров 4.3 — среднее 4.1\"\n   - Данные: агрегаты через admin client из всех тенантов (анонимизированные)\n\nUI: Секция на HR-дашборде\n- Карточки инсайтов с severity-цветами (зелёный/жёлтый/красный)\n- Прогноз утилизации: gauge chart или progress bar с прогнозной отметкой\n- Бенчмарки: горизонтальные бары \"вы vs рынок\"\n\nФайлы:\n- src/lib/services/analytics.service.ts — вся логика расчётов\n- src/app/api/hr/analytics/predictions/route.ts\n- src/app/api/hr/analytics/insights/route.ts\n- src/app/api/hr/analytics/benchmarks/route.ts\n- src/components/analytics/insights-panel.tsx\n- src/components/analytics/prediction-gauge.tsx\n- src/components/analytics/benchmark-bars.tsx","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-27T09:15:16.413583+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:15:16.413583+03:00","dependencies":[{"issue_id":"benefit-market-5p6.2","depends_on_id":"benefit-market-5p6","type":"parent-child","created_at":"2026-02-27T09:15:16.414426+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-5p6.2","depends_on_id":"benefit-market-5p6.1","type":"blocks","created_at":"2026-02-27T09:15:35.32012+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-5p6.3","title":"Аналитика wellbeing: опросы и eNPS","description":"Система анонимных опросов для измерения удовлетворённости льготами и wellbeing.\n\nНОВЫЕ ТАБЛИЦЫ:\n1. surveys:\n   - id, tenant_id, title, description\n   - type: \"enps\" | \"satisfaction\" | \"custom\"\n   - status: \"draft\" | \"active\" | \"closed\"\n   - starts_at, ends_at\n   - created_by (FK-\u003eusers)\n   - created_at\n\n2. survey_questions:\n   - id, survey_id (FK-\u003esurveys)\n   - question_text, question_type: \"rating_1_10\" | \"rating_1_5\" | \"text\" | \"single_choice\" | \"multi_choice\"\n   - options (jsonb) — варианты для choice\n   - sort_order\n   - is_required\n\n3. survey_responses:\n   - id, survey_id (FK-\u003esurveys), tenant_id\n   - respondent_hash (анонимизированный hash от user_id + survey_id, чтобы не дать ответить дважды, но НЕ хранить user_id)\n   - answers (jsonb) — { question_id: answer_value }\n   - created_at\n   - UNIQUE(survey_id, respondent_hash)\n   - ВАЖНО: НЕТ user_id — полная анонимность\n\nRLS:\n- surveys: HR/admin CRUD, employee SELECT active\n- survey_questions: через survey access\n- survey_responses: INSERT любой (через respondent_hash), SELECT только HR/admin (агрегаты)\n\nAPI:\n- CRUD /api/hr/surveys — управление опросами\n- GET /api/surveys/active — активные опросы для сотрудника\n- POST /api/surveys/[id]/respond — анонимный ответ\n- GET /api/hr/surveys/[id]/results — результаты (только агрегаты\\!)\n  - eNPS score: (promoters% - detractors%) * 100\n  - Распределение ответов по вопросам\n  - Количество респондентов\n\nUI:\n- HR: создание опроса, просмотр результатов\n- Employee: заполнение опроса (виджет в дашборде)\n- Аналитика: eNPS trend, распределение, корреляция с утилизацией льгот\n\nФайлы:\n- supabase/migrations/00006_surveys.sql\n- src/app/api/hr/surveys/route.ts\n- src/app/api/hr/surveys/[id]/route.ts\n- src/app/api/hr/surveys/[id]/results/route.ts\n- src/app/api/surveys/active/route.ts\n- src/app/api/surveys/[id]/respond/route.ts\n- src/app/dashboard/hr/surveys/page.tsx\n- src/app/dashboard/hr/surveys/new/page.tsx\n- src/app/dashboard/hr/surveys/[id]/results/page.tsx\n- src/components/surveys/survey-form.tsx\n- src/components/surveys/survey-results.tsx\n- src/components/surveys/enps-gauge.tsx","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-27T09:15:30.246765+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:15:30.246765+03:00","dependencies":[{"issue_id":"benefit-market-5p6.3","depends_on_id":"benefit-market-5p6","type":"parent-child","created_at":"2026-02-27T09:15:30.248314+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-653","title":"Peer Recognition: frontend UI","description":"Фронтенд системы благодарностей.\n\nКОМПОНЕНТЫ:\n1. src/components/recognition/recognition-wall.tsx\n   - Лента благодарностей (как соцсеть)\n   - Карточка: аватар from → аватар to, сообщение, категория-бейдж, баллы, дата\n   - Фильтр по категории\n\n2. src/components/recognition/send-recognition-form.tsx\n   - Модалка 'Отправить благодарность'\n   - Выбор коллеги (search/dropdown)\n   - Кол-во баллов (slider, min-max из настроек)\n   - Категория (select)\n   - Текст благодарности (textarea, min 10 chars)\n   - Остаток бюджета показан\n\n3. src/components/recognition/recognition-budget.tsx\n   - Виджет: 'Осталось 350 из 500 баллов на благодарности'\n   - Progress bar\n\n4. src/components/recognition/recognition-leaderboard.tsx\n   - Топ-5 самых ценных коллег (по полученным баллам)\n   - Топ-5 самых благодарных (по отправленным)\n\nСТРАНИЦЫ:\n- src/app/dashboard/employee/recognition/page.tsx — стена + форма + лидерборд\n\nИНТЕГРАЦИЯ:\n- Мини-виджет на главной employee dashboard: 'Последние благодарности'\n- Навигация: добавить 'Благодарности' в sidebar (Heart icon)\n\nФайлы:\n- src/app/dashboard/employee/recognition/page.tsx\n- src/components/recognition/recognition-wall.tsx\n- src/components/recognition/send-recognition-form.tsx\n- src/components/recognition/recognition-budget.tsx\n- src/components/recognition/recognition-leaderboard.tsx\n- src/components/layout/app-sidebar.tsx (добавить пункт)","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-27T09:16:59.396251+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:16:59.396251+03:00","dependencies":[{"issue_id":"benefit-market-653","depends_on_id":"benefit-market-vwk","type":"blocks","created_at":"2026-02-27T09:17:09.890297+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-6b1","title":"TypeScript типы для маркетплейса","description":"Обновить типы для поддержки маркетплейса.\n\nФайлы:\n- src/lib/types/database.ts — добавить Row/Insert/Update для: providers, provider_offerings, tenant_offerings, reviews, global_categories, provider_users. Добавить enum типы: provider_status, offering_status, review_status. Обновить user_role добавив 'provider'.\n- src/lib/types/index.ts — добавить алиасы: Provider, ProviderInsert, ProviderUpdate, ProviderOffering, ProviderOfferingInsert, ProviderOfferingUpdate, TenantOffering, TenantOfferingInsert, TenantOfferingUpdate, Review, ReviewInsert, ReviewUpdate, GlobalCategory, GlobalCategoryInsert, GlobalCategoryUpdate, ProviderUser, ProviderUserInsert.\n\nСледовать существующим паттернам (Tables\u003c'tablename'\u003e, Inserts\u003c'tablename'\u003e, Updates\u003c'tablename'\u003e).","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-27T08:57:24.150951+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:15:31.691847+03:00","closed_at":"2026-02-27T09:15:31.691847+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-6b1","depends_on_id":"benefit-market-dlq","type":"blocks","created_at":"2026-02-27T08:57:54.811388+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-6e7","title":"Epic 8: Service Layer and Atomic Transactions","description":"## Epic 8: Service Layer \u0026 Atomic Transactions\n\n### Контекст\nБизнес-логика размазана по route handlers (создание заказа = 3 отдельных DB запроса без транзакции). Нет service layer. Routes раздутые (100-200 строк).\n\n### Задачи\n1. **Order service + atomic SQL** — `src/lib/services/order.service.ts` + `supabase/migrations/003_create_order_atomic.sql`: атомарная функция create_order_and_reserve().\n2. **Other services** — benefit.service.ts, wallet.service.ts, employee.service.ts, tenant.service.ts, audit.service.ts\n3. **Request validators** — `src/lib/api/validators.ts`: Zod-схемы для всех API inputs.\n4. **Thin route handlers** — рефакторинг всех 22 routes до 30-50 строк (auth middleware + validator + service call + response helper).\n5. **Admin client singleton** — `src/lib/supabase/admin.ts`: lazy singleton для admin client.\n\n### Зависимости\nЗависит от Epic 6 (auth middleware, response helpers, typed queries)\n\n### Верификация\n- Все routes \u003c 50 LOC\n- Build passes\n- Order creation атомарна (rollback при ошибке)\n- Все flow работают end-to-end","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-25T23:54:46.782285+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:38:00.717996+03:00","closed_at":"2026-02-26T00:38:00.717996+03:00","close_reason":"Service layer created (order, dashboard, accrual). Validators centralized. Admin client singleton. Dashboard 296→19 LOC, accrual 277→18 LOC, orders 386→134 LOC. Build passes.","dependencies":[{"issue_id":"benefit-market-6e7","depends_on_id":"benefit-market-1is","type":"blocks","created_at":"2026-02-25T23:59:26.166427+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-6e7","depends_on_id":"benefit-market-1z2","type":"blocks","created_at":"2026-02-25T23:59:26.431314+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-72y","title":"Epic 3: HR Policies Page","description":"## Epic 3: HR Policies Page\n\n### Контекст\nHR-менеджеры не могут просматривать бюджетные политики — страница /dashboard/hr/policies это стаб (7 строк, только заголовок). API /api/admin/policies разрешает доступ только admin, HR получает 403.\n\n### Задачи\n- 3.1 Allow HR role in policies API GET (benefit-market-of5)\n- 3.2 Implement HR policies page (benefit-market-rbk)\n\n### Верификация\n- HR видит таблицу политик с пагинацией\n- Нет кнопок создания/редактирования (read-only)\n- Пагинация работает\n- Loading и empty states отображаются","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-25T23:54:21.121383+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:03:53.066955+03:00","closed_at":"2026-02-26T00:03:53.066955+03:00","close_reason":"Closed"}
{"id":"benefit-market-73a","title":"Фундамент: проект, схема БД, авторизация","description":"Недели 1-2. Инициализация проекта Next.js + Supabase, SQL-схема всех таблиц с RLS-политиками, аутентификация, каркас трёх кабинетов (employee/hr/admin), seed-данные.","status":"closed","priority":0,"issue_type":"epic","created_at":"2026-02-25T21:50:48.960381+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:23:34.909361+03:00","closed_at":"2026-02-25T22:23:34.909361+03:00","close_reason":"Фундамент полностью готов: проект, схема, auth, middleware, layouts, RLS, seed","dependencies":[{"issue_id":"benefit-market-73a","depends_on_id":"benefit-market-09b","type":"blocks","created_at":"2026-02-25T21:55:14.864257+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-73a.1","title":"Инициализация Next.js 14 + TypeScript + Tailwind + shadcn/ui","description":"Создать проект Next.js 14 (App Router) с TypeScript strict mode. Установить Tailwind CSS, shadcn/ui. Настроить структуру папок:\n- app/(employee)/ — кабинет сотрудника\n- app/(hr)/ — кабинет HR\n- app/(admin)/ — кабинет админа\n- app/api/ — API routes\n- lib/ — утилиты, supabase client, types\n- components/ — переиспользуемые компоненты\n\nНастроить ESLint, Prettier. Добавить .env.local.example.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:52:15.645368+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:19:52.028374+03:00","closed_at":"2026-02-25T22:19:52.028374+03:00","close_reason":"Реализовано: Next.js 14 + Supabase + SQL schema + Auth + Middleware + Layouts","dependencies":[{"issue_id":"benefit-market-73a.1","depends_on_id":"benefit-market-73a","type":"parent-child","created_at":"2026-02-25T21:52:15.646749+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-73a.10","title":"Layout трёх кабинетов с навигацией","description":"Создать layout для каждого кабинета:\n\nEmployee layout:\n- Sidebar/header: Каталог, Мои заказы, Кошелёк, Профиль\n- Отображение баланса баллов в header\n\nHR layout:\n- Sidebar: Дашборд, Сотрудники, Импорт, Политики\n- Название компании в header\n\nAdmin layout:\n- Sidebar: Tenant'ы, Каталог, Политики, Правила, Пользователи, Аудит-лог\n- Индикатор выбранного tenant'а\n\nОбщее: тёмная/светлая тема, адаптивный sidebar (collapse на мобильных), breadcrumbs.","status":"closed","priority":2,"issue_type":"task","estimated_minutes":180,"created_at":"2026-02-25T21:52:45.931747+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:19:52.531313+03:00","closed_at":"2026-02-25T22:19:52.531313+03:00","close_reason":"Реализовано: Next.js 14 + Supabase + SQL schema + Auth + Middleware + Layouts","dependencies":[{"issue_id":"benefit-market-73a.10","depends_on_id":"benefit-market-73a","type":"parent-child","created_at":"2026-02-25T21:52:45.932602+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-73a.11","title":"Seed-данные: тестовый tenant, пользователи, льготы","description":"Создать seed-скрипт (supabase/seed.sql или scripts/seed.ts):\n\n1 tenant: ООО 'Тестовая компания'\n3 пользователя: employee@test.com, hr@test.com, admin@test.com\n5 employee_profiles с разными грейдами/локациями\n3 benefit_categories: Здоровье, Обучение, Спорт\n10 benefits с разными ценами и лимитами\n3 eligibility_rules\n2 budget_policies\nКошельки с начальным балансом для каждого сотрудника\n\nСкрипт должен быть идемпотентным (можно запускать повторно).","status":"closed","priority":2,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-25T21:52:48.435778+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:23:34.693626+03:00","closed_at":"2026-02-25T22:23:34.693626+03:00","close_reason":"RLS-политики и seed-данные созданы","dependencies":[{"issue_id":"benefit-market-73a.11","depends_on_id":"benefit-market-73a","type":"parent-child","created_at":"2026-02-25T21:52:48.43638+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-73a.2","title":"Подключение Supabase (Auth + DB + Storage)","description":"Создать проект в Supabase. Настроить клиенты:\n- lib/supabase/client.ts — браузерный клиент\n- lib/supabase/server.ts — серверный клиент (cookies)\n- lib/supabase/admin.ts — service role клиент (для Edge Functions)\n\nНастроить Supabase Auth: email + пароль. Проверить flow регистрации и входа.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-25T21:52:18.941661+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:19:52.088394+03:00","closed_at":"2026-02-25T22:19:52.088394+03:00","close_reason":"Реализовано: Next.js 14 + Supabase + SQL schema + Auth + Middleware + Layouts","dependencies":[{"issue_id":"benefit-market-73a.2","depends_on_id":"benefit-market-73a","type":"parent-child","created_at":"2026-02-25T21:52:18.942319+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-73a.3","title":"SQL-схема: tenants, users, employee_profiles","description":"Создать миграцию Supabase с таблицами:\n\nCREATE TABLE tenants (id uuid PK, name text NOT NULL, domain text, settings jsonb DEFAULT '{}', created_at timestamptz DEFAULT now());\n\nCREATE TABLE users (id uuid PK, tenant_id uuid FK REFERENCES tenants, auth_id uuid FK REFERENCES auth.users, email text NOT NULL, role text CHECK (role IN ('employee','hr','admin')), created_at timestamptz DEFAULT now());\n\nCREATE TABLE employee_profiles (id uuid PK, user_id uuid FK REFERENCES users, tenant_id uuid FK REFERENCES tenants, grade text, tenure_months int, location text, legal_entity text, extra jsonb DEFAULT '{}');\n\nИндексы на tenant_id для каждой таблицы. UNIQUE(auth_id) на users.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":60,"created_at":"2026-02-25T21:52:23.881811+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:19:52.148421+03:00","closed_at":"2026-02-25T22:19:52.148421+03:00","close_reason":"Реализовано: Next.js 14 + Supabase + SQL schema + Auth + Middleware + Layouts","dependencies":[{"issue_id":"benefit-market-73a.3","depends_on_id":"benefit-market-73a","type":"parent-child","created_at":"2026-02-25T21:52:23.8825+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-73a.4","title":"SQL-схема: benefits, benefit_categories, eligibility_rules","description":"Создать миграцию с таблицами каталога:\n\nbenefit_categories (id, tenant_id FK, name, icon, sort_order)\nbenefits (id, tenant_id FK, category_id FK, name, description, price_points int, stock_limit int nullable, is_active boolean DEFAULT true, created_at)\neligibility_rules (id, benefit_id FK, tenant_id FK, conditions jsonb)\n\nconditions — JSONB с фильтрами: {grade: ['senior','middle'], min_tenure: 6, location: ['Moscow']}\nИндексы: benefits(tenant_id, is_active), eligibility_rules(benefit_id).","status":"closed","priority":1,"issue_type":"task","estimated_minutes":60,"created_at":"2026-02-25T21:52:28.387747+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:19:52.211787+03:00","closed_at":"2026-02-25T22:19:52.211787+03:00","close_reason":"Реализовано: Next.js 14 + Supabase + SQL schema + Auth + Middleware + Layouts","dependencies":[{"issue_id":"benefit-market-73a.4","depends_on_id":"benefit-market-73a","type":"parent-child","created_at":"2026-02-25T21:52:28.388386+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-73a.5","title":"SQL-схема: wallets, point_ledger, budget_policies","description":"Создать миграцию с таблицами кошельков:\n\nwallets (id, user_id FK, tenant_id FK, balance int DEFAULT 0, reserved int DEFAULT 0, period text e.g. '2025-Q1', expires_at timestamptz)\nCHECK (balance \u003e= 0), CHECK (reserved \u003e= 0)\nUNIQUE(user_id, period)\n\npoint_ledger (id, wallet_id FK, tenant_id FK, order_id FK nullable, type text CHECK IN ('accrual','reserve','spend','release','expire'), amount int NOT NULL, description text, created_at DEFAULT now())\nAppend-only: никаких UPDATE/DELETE.\n\nbudget_policies (id, tenant_id FK, name, points_amount int, period text CHECK IN ('monthly','quarterly','yearly'), target_filter jsonb, is_active boolean DEFAULT true)","status":"closed","priority":1,"issue_type":"task","estimated_minutes":60,"created_at":"2026-02-25T21:52:33.310512+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:19:52.282134+03:00","closed_at":"2026-02-25T22:19:52.282134+03:00","close_reason":"Реализовано: Next.js 14 + Supabase + SQL schema + Auth + Middleware + Layouts","dependencies":[{"issue_id":"benefit-market-73a.5","depends_on_id":"benefit-market-73a","type":"parent-child","created_at":"2026-02-25T21:52:33.311115+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-73a.6","title":"SQL-схема: orders, order_items, audit_log","description":"Создать миграцию:\n\norders (id, user_id FK, tenant_id FK, status text CHECK IN ('pending','reserved','paid','cancelled','expired'), total_points int, reserved_at timestamptz, expires_at timestamptz, created_at DEFAULT now())\n\norder_items (id, order_id FK, benefit_id FK, quantity int DEFAULT 1, price_points int)\n\naudit_log (id, tenant_id FK, user_id FK, action text, entity_type text, entity_id uuid, diff jsonb, created_at DEFAULT now())\n\nИндексы: orders(user_id, status), orders(tenant_id, status), orders(status, expires_at) для TTL cron.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":60,"created_at":"2026-02-25T21:52:36.219869+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:19:52.345194+03:00","closed_at":"2026-02-25T22:19:52.345194+03:00","close_reason":"Реализовано: Next.js 14 + Supabase + SQL schema + Auth + Middleware + Layouts","dependencies":[{"issue_id":"benefit-market-73a.6","depends_on_id":"benefit-market-73a","type":"parent-child","created_at":"2026-02-25T21:52:36.220444+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-73a.7","title":"RLS-политики для всех таблиц","description":"Включить RLS на всех таблицах. Создать политики:\n\ntenants: admin видит все, остальные — только свой tenant.\nusers: admin — все, hr — свой tenant, employee — только себя.\nemployee_profiles: hr/admin — свой tenant, employee — только себя.\nbenefits: все роли — свой tenant + is_active (employee), admin — все.\nbenefit_categories: все роли — свой tenant.\neligibility_rules: admin — свой tenant.\nbudget_policies: hr/admin — свой tenant.\nwallets: employee — только свои, hr/admin — свой tenant.\npoint_ledger: INSERT только через service_role. SELECT: employee — свои, hr/admin — свой tenant.\norders: employee — свои, hr/admin — свой tenant.\norder_items: через join с orders.\naudit_log: admin — свой tenant.\n\nJWT содержит tenant_id и role в app_metadata.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":180,"created_at":"2026-02-25T21:52:39.804753+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:23:34.633422+03:00","closed_at":"2026-02-25T22:23:34.633422+03:00","close_reason":"RLS-политики и seed-данные созданы","dependencies":[{"issue_id":"benefit-market-73a.7","depends_on_id":"benefit-market-73a","type":"parent-child","created_at":"2026-02-25T21:52:39.805382+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-73a.8","title":"Supabase Auth: JWT custom claims (role, tenant_id)","description":"Настроить Supabase Auth hook или database function для добавления custom claims в JWT:\n- tenant_id — из таблицы users\n- role — из таблицы users\n\nСоздать функцию:\nCREATE OR REPLACE FUNCTION auth.custom_access_token_hook(event jsonb) RETURNS jsonb\nКоторая добавляет в token claims из таблицы users по auth.uid().\n\nЭто критично — без claims RLS-политики не работают.\nТестировать: зарегистрировать пользователя, проверить JWT в jwt.io.","status":"closed","priority":0,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:52:41.894556+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:19:52.407873+03:00","closed_at":"2026-02-25T22:19:52.407873+03:00","close_reason":"Реализовано: Next.js 14 + Supabase + SQL schema + Auth + Middleware + Layouts","dependencies":[{"issue_id":"benefit-market-73a.8","depends_on_id":"benefit-market-73a","type":"parent-child","created_at":"2026-02-25T21:52:41.895161+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-73a.9","title":"Middleware: route protection по ролям","description":"Создать middleware.ts в корне проекта:\n- Проверять наличие сессии Supabase Auth.\n- Извлекать role из JWT.\n- Маршруты /dashboard/employee/* — только employee.\n- Маршруты /dashboard/hr/* — только hr, admin.\n- Маршруты /dashboard/admin/* — только admin.\n- /auth/* — доступ без аутентификации.\n- Редирект неавторизованных на /auth/login.\n- Редирект при недостаточных правах на страницу своего кабинета.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-25T21:52:43.668667+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:19:52.468205+03:00","closed_at":"2026-02-25T22:19:52.468205+03:00","close_reason":"Реализовано: Next.js 14 + Supabase + SQL schema + Auth + Middleware + Layouts","dependencies":[{"issue_id":"benefit-market-73a.9","depends_on_id":"benefit-market-73a","type":"parent-child","created_at":"2026-02-25T21:52:43.669236+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-79o","title":"Order service: поддержка marketplace-заказов","description":"Расширить систему заказов для поддержки marketplace-предложений.\n\nИЗМЕНЕНИЯ:\n1. src/lib/services/order.service.ts — createOrder():\n   - Принимать items с tenant_offering_id (наряду с benefit_id)\n   - Для marketplace items:\n     - Получить tenant_offering → проверить is_active\n     - Получить provider_offering → проверить status=published\n     - Получить provider → проверить status=verified\n     - Цена: tenant_offering.custom_price_points ?? provider_offering.base_price_points\n     - Stock: tenant_offering.tenant_stock_limit ?? provider_offering.stock_limit\n     - Eligibility check через eligibility_rules WHERE tenant_offering_id = ...\n   - order_items: заполнять provider_offering_id и tenant_offering_id\n   - Остальная логика (wallet reserve, point_ledger) без изменений\n\n2. src/app/api/orders/route.ts — POST:\n   - Обновить Zod-схему для items: { benefit_id?: uuid, tenant_offering_id?: uuid, quantity: int }\n   - CHECK: ровно одно из benefit_id или tenant_offering_id\n\n3. src/lib/store/cart.ts — Cart store:\n   - CartBenefit type: добавить optional tenant_offering_id\n   - addItem() / updateQuantity(): поддержать оба типа\n   - getTotalPoints(): без изменений (уже считает по price)\n\n4. GET /api/orders — обновить для отображения marketplace items:\n   - JOIN order_items с provider_offerings и providers\n   - Вернуть provider name и logo в ответе\n\n5. Обратная совместимость: существующие заказы с benefit_id продолжают работать","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T08:59:24.365586+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:22:52.333186+03:00","closed_at":"2026-02-27T09:22:52.333186+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-79o","depends_on_id":"benefit-market-a0w","type":"blocks","created_at":"2026-02-27T09:00:41.351362+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-79o","depends_on_id":"benefit-market-6b1","type":"blocks","created_at":"2026-02-27T09:00:41.608682+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-7l7","title":"5.6 HR dashboard CSV export","description":"## 5.6 HR dashboard CSV export\n\n### Файл\n`src/app/dashboard/hr/page.tsx`\n\n### Текущее состояние\nHR дашборд показывает метрики и графики, но нет возможности экспортировать данные.\n\n### Что сделать\n1. Добавить кнопку 'Экспорт в CSV' в header (рядом с заголовком)\n2. При клике:\n   - Использовать papaparse (уже в зависимостях) для генерации CSV\n   - Данные: popular_benefits + category_distribution + summary\n   - Создать Blob и скачать через URL.createObjectURL + a.click()\n3. Кнопка disabled пока data не загружена\n\n```typescript\nimport Papa from 'papaparse';\nimport { Download } from 'lucide-react';\n\nfunction handleExportCsv() {\n  if (!data) return;\n  const rows = data.popular_benefits.map(b =\u003e ({\n    'Льгота': b.name,\n    'Заказов': b.order_count,\n    'Баллов': b.total_points,\n  }));\n  const csv = Papa.unparse(rows);\n  const blob = new Blob(['\\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });\n  const url = URL.createObjectURL(blob);\n  const a = document.createElement('a');\n  a.href = url;\n  a.download = 'hr-dashboard-export.csv';\n  a.click();\n  URL.revokeObjectURL(url);\n}\n```\n\n### Верификация\n- Кнопка появляется после загрузки данных\n- CSV файл скачивается с корректными данными\n- BOM (\\ufeff) обеспечивает корректное отображение кириллицы в Excel","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-25T23:54:41.987635+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:09:22.905602+03:00","closed_at":"2026-02-26T00:09:22.905602+03:00","close_reason":"Closed"}
{"id":"benefit-market-83x","title":"Epic 13: DevOps","description":"## Epic 13: DevOps\n\n### Задачи\n1. **Pre-commit hooks** — husky + lint-staged (eslint, prettier, tsc --noEmit)\n2. **CI/CD** — .github/workflows/ci.yml: lint, typecheck, test, build, playwright\n3. **Docker** — Dockerfile + docker-compose.yml для local development\n4. **ESLint strengthening** — strict rules, no-any, no-explicit-any\n\n### Верификация\n- Pre-commit hooks блокируют плохой код\n- CI pipeline зелёный\n- docker-compose up запускает приложение","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-25T23:54:54.882381+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:52:37.811897+03:00","closed_at":"2026-02-26T00:52:37.811897+03:00","close_reason":"CI/CD pipeline, Dockerfile, docker-compose.yml created. Vitest config fixed.","dependencies":[{"issue_id":"benefit-market-83x","depends_on_id":"benefit-market-9hx","type":"blocks","created_at":"2026-02-25T23:59:27.789209+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-8wa","title":"4.1 Add PATCH/DELETE to categories API","description":"## 4.1 Add PATCH/DELETE to categories API\n\n### Файл\n`src/app/api/admin/categories/route.ts`\n\n### Текущее состояние\nТолько GET и POST handlers. Нет возможности обновлять или удалять категории.\n\n### Что сделать\n1. Добавить PATCH handler:\n   - Валидация: z.object({ id: z.string().uuid(), name, icon, sort_order — все optional })\n   - Auth + role check (admin only)\n   - admin.from('benefit_categories').update({...}).eq('id', id).eq('tenant_id', appUser.tenant_id).select().single()\n2. Добавить DELETE handler:\n   - Params: id из body или searchParams\n   - Auth + role check (admin only)\n   - Проверить что нет benefits привязанных к категории (или каскадный delete)\n   - admin.from('benefit_categories').delete().eq('id', id).eq('tenant_id', appUser.tenant_id)\n\n### Верификация\n- PATCH обновляет name, icon, sort_order\n- DELETE удаляет категорию\n- 401 без авторизации, 403 для не-admin\n- Валидация работает","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-25T23:54:27.395467+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:06:31.43596+03:00","closed_at":"2026-02-26T00:06:31.43596+03:00","close_reason":"Closed"}
{"id":"benefit-market-91x","title":"API + UI: модерация предложений и глобальные категории","description":"Админ-функционал для модерации предложений провайдеров и управления глобальными категориями.\n\nМОДЕРАЦИЯ ПРЕДЛОЖЕНИЙ:\n1. GET /api/admin/offerings — все предложения (кросс-провайдерные)\n   - Фильтры: status (draft/pending_review/published/archived), provider_id, category\n   - Пагинация\n   - JOIN providers (name, status)\n\n2. PATCH /api/admin/offerings/[id] — обновить статус\n   - pending_review → published (одобрить)\n   - pending_review → draft (отклонить, вернуть на доработку)\n   - published → archived (снять с публикации)\n   - Аудит-лог\n\nГЛОБАЛЬНЫЕ КАТЕГОРИИ:\n3. GET /api/admin/global-categories — список\n4. POST /api/admin/global-categories — создать (name unique, icon, sort_order)\n5. PATCH /api/admin/global-categories/[id] — обновить\n6. DELETE /api/admin/global-categories/[id] — удалить (только если нет привязанных offerings)\n\nUI СТРАНИЦЫ:\n- src/app/dashboard/admin/offerings/page.tsx (модерация)\n  - Таблица: название, провайдер, категория, цена, статус, дата\n  - Вкладки по статусу (фокус на pending_review)\n  - Действия: Approve / Reject / Archive\n- src/app/dashboard/admin/global-categories/page.tsx\n  - CRUD таблица с inline-редактированием\n\nФайлы:\n- src/app/api/admin/offerings/route.ts\n- src/app/api/admin/offerings/[id]/route.ts\n- src/app/api/admin/global-categories/route.ts\n- src/app/api/admin/global-categories/[id]/route.ts\n- src/app/dashboard/admin/offerings/page.tsx\n- src/app/dashboard/admin/global-categories/page.tsx","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T08:58:39.207879+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:19:00.102124+03:00","closed_at":"2026-02-27T09:19:00.102124+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-91x","depends_on_id":"benefit-market-msy","type":"blocks","created_at":"2026-02-27T09:00:40.135302+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-91x","depends_on_id":"benefit-market-svr","type":"blocks","created_at":"2026-02-27T09:00:40.405593+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-93m","title":"Epic 9: React Query Data Layer","description":"## Epic 9: React Query Data Layer\n\n### Контекст\nВсе 13+ страниц используют useEffect + fetch + useState для загрузки данных. Нет кэширования, нет автоматической инвалидации, много boilerplate.\n\n### Задачи\n1. Install + configure React Query (@tanstack/react-query), добавить QueryProvider в layout\n2. Typed API client — `src/lib/api/client.ts`: обёртка над fetch с типизацией\n3. Query hooks: use-benefits, use-orders, use-wallet, use-employees, use-dashboard, use-categories\n4. Mutation hooks: use-create-order, use-cancel-order, use-confirm-order (с invalidation)\n5. Migrate all 13+ pages с useEffect+fetch на hooks\n\n### Зависимости\nЗависит от Epic 8 (service layer, standardized API responses)\n\n### Верификация\n- Кэширование работает (повторный заход на страницу — мгновенно)\n- Мутации автоматически инвалидируют queries\n- Нет useEffect+fetch в pages\n- Loading/error states через React Query","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-25T23:54:48.440931+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:42:48.631916+03:00","closed_at":"2026-02-26T00:42:48.631916+03:00","close_reason":"React Query installed, QueryProvider in layout, typed API client, 6 query hook files (benefits, orders, wallet, employees, dashboard, categories) with mutations + cache invalidation. Build passes.","dependencies":[{"issue_id":"benefit-market-93m","depends_on_id":"benefit-market-6e7","type":"blocks","created_at":"2026-02-25T23:59:26.693499+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-94r","title":"Заказы, HR-кабинет и импорт","description":"Недели 5-6. Корзина, оформление заказов с резервом баллов, подтверждение/отмена, TTL резервов, CSV-импорт сотрудников, HR-дашборд с графиками на recharts.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-25T21:50:52.04065+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:39:17.973016+03:00","closed_at":"2026-02-25T22:39:17.973016+03:00","close_reason":"Epic 3 полностью готов","dependencies":[{"issue_id":"benefit-market-94r","depends_on_id":"benefit-market-ivk","type":"blocks","created_at":"2026-02-25T21:55:13.095569+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-94r.1","title":"API: POST /api/orders — создание заказа с резервом баллов","description":"Next.js API route POST /api/orders:\n\nBody: { items: [{ benefit_id, quantity }] }\nДоступ: employee.\n\nАлгоритм:\n1. Валидация Zod: items не пуст, quantity \u003e 0.\n2. Проверить eligibility для каждой льготы.\n3. Проверить stock_limit (если есть).\n4. Рассчитать total_points = SUM(price_points * quantity).\n5. Проверить wallet.balance - wallet.reserved \u003e= total_points.\n6. В транзакции:\n   a. Создать order (status=reserved, reserved_at=now(), expires_at=now()+15min).\n   b. Создать order_items.\n   c. Создать point_ledger записи type=reserve.\n   d. Увеличить wallet.reserved на total_points.\n7. Вернуть order с items.\n\nОшибки: insufficient_points, benefit_not_available, stock_exceeded.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":180,"created_at":"2026-02-25T21:53:29.847499+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:39:17.160027+03:00","closed_at":"2026-02-25T22:39:17.160027+03:00","close_reason":"Orders API, cart, HR dashboard, CSV import, employee list реализованы","dependencies":[{"issue_id":"benefit-market-94r.1","depends_on_id":"benefit-market-94r","type":"parent-child","created_at":"2026-02-25T21:53:29.848085+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-94r.10","title":"UI: HR-дашборд на recharts","description":"Страница /dashboard/hr:\n\nКарточки-метрики вверху:\n- Общий бюджет / Потрачено / Утилизация %\n- Всего сотрудников / Активных\n\nГрафики (recharts):\n- BarChart: топ-5 популярных льгот.\n- PieChart: распределение по категориям.\n- LineChart/AreaChart: динамика начислений/списаний по месяцам.\n\nResponsive: на мобильных графики в 1 колонку.\nSkeleton loading для каждого блока.\n\nКомпоненты: MetricCard, BenefitPopularityChart, CategoryPieChart, TrendChart.\nshadcn/ui Card + recharts.","status":"closed","priority":2,"issue_type":"task","estimated_minutes":180,"created_at":"2026-02-25T21:53:53.061968+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:39:17.749176+03:00","closed_at":"2026-02-25T22:39:17.749176+03:00","close_reason":"Orders API, cart, HR dashboard, CSV import, employee list реализованы","dependencies":[{"issue_id":"benefit-market-94r.10","depends_on_id":"benefit-market-94r","type":"parent-child","created_at":"2026-02-25T21:53:53.062647+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-94r.2","title":"API: POST /api/orders/:id/confirm — подтверждение заказа","description":"Next.js API route POST /api/orders/:id/confirm:\n\nДоступ: employee (только свои заказы).\n\nАлгоритм:\n1. Найти order по id, проверить принадлежность user_id.\n2. Проверить status = 'reserved'.\n3. Проверить expires_at \u003e now() (не истёк).\n4. В транзакции:\n   a. order.status = 'paid'.\n   b. Создать point_ledger type=spend (отрицательная запись).\n   c. Уменьшить wallet.balance на total_points.\n   d. Уменьшить wallet.reserved на total_points.\n   e. Если есть stock_limit — уменьшить stock.\n5. Записать в audit_log.\n\nОшибки: order_not_found, order_expired, invalid_status.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:53:32.482789+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:39:17.226926+03:00","closed_at":"2026-02-25T22:39:17.226926+03:00","close_reason":"Orders API, cart, HR dashboard, CSV import, employee list реализованы","dependencies":[{"issue_id":"benefit-market-94r.2","depends_on_id":"benefit-market-94r","type":"parent-child","created_at":"2026-02-25T21:53:32.483396+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-94r.3","title":"API: POST /api/orders/:id/cancel — отмена заказа","description":"Next.js API route POST /api/orders/:id/cancel:\n\nДоступ: employee (только свои заказы).\n\nАлгоритм:\n1. Найти order по id, проверить user_id.\n2. Проверить status = 'reserved' (paid нельзя отменить в MVP).\n3. В транзакции:\n   a. order.status = 'cancelled'.\n   b. Создать point_ledger type=release.\n   c. Уменьшить wallet.reserved на total_points.\n4. Записать в audit_log.\n\nОшибки: order_not_found, cannot_cancel_paid.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-25T21:53:34.667668+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:39:17.293055+03:00","closed_at":"2026-02-25T22:39:17.293055+03:00","close_reason":"Orders API, cart, HR dashboard, CSV import, employee list реализованы","dependencies":[{"issue_id":"benefit-market-94r.3","depends_on_id":"benefit-market-94r","type":"parent-child","created_at":"2026-02-25T21:53:34.668249+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-94r.4","title":"UI: Корзина и оформление заказа","description":"Реализовать flow покупки:\n\n1. Корзина (client-side state, zustand или context):\n   - Добавление/удаление льгот.\n   - Изменение количества.\n   - Отображение суммы в баллах.\n   - Сравнение с доступным балансом.\n   - Persist в localStorage.\n\n2. Страница /dashboard/employee/cart:\n   - Список позиций с ценами.\n   - Итого баллов.\n   - Предупреждение если баллов не хватает.\n   - Кнопка 'Оформить заказ' → POST /api/orders.\n   - После создания → переход на страницу заказа.\n\n3. Страница /dashboard/employee/orders/:id:\n   - Статус заказа (reserved/paid/cancelled/expired).\n   - Таймер TTL (осталось X минут на подтверждение).\n   - Кнопки: 'Подтвердить', 'Отменить' (если reserved).\n\nshadcn/ui: Card, Button, Badge, Alert.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":240,"created_at":"2026-02-25T21:53:37.962804+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:39:17.353434+03:00","closed_at":"2026-02-25T22:39:17.353434+03:00","close_reason":"Orders API, cart, HR dashboard, CSV import, employee list реализованы","dependencies":[{"issue_id":"benefit-market-94r.4","depends_on_id":"benefit-market-94r","type":"parent-child","created_at":"2026-02-25T21:53:37.963405+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-94r.5","title":"UI: История заказов сотрудника","description":"Страница /dashboard/employee/orders:\n\n- Список заказов: дата, статус, сумма баллов, количество позиций.\n- Фильтр по статусу (все / активные / завершённые).\n- Сортировка по дате (новые первые).\n- Клик → детали заказа.\n- Статус-бейджи с цветовым кодированием:\n  reserved — жёлтый, paid — зелёный, cancelled — серый, expired — красный.\n\nAPI: GET /api/orders (с пагинацией, фильтром по статусу).","status":"closed","priority":2,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-25T21:53:40.07787+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:39:17.416481+03:00","closed_at":"2026-02-25T22:39:17.416481+03:00","close_reason":"Orders API, cart, HR dashboard, CSV import, employee list реализованы","dependencies":[{"issue_id":"benefit-market-94r.5","depends_on_id":"benefit-market-94r","type":"parent-child","created_at":"2026-02-25T21:53:40.078495+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-94r.6","title":"Edge Function: TTL резервов (cron)","description":"Supabase Edge Function + pg_cron:\n\nЗапускается каждые 5 минут.\n\nАлгоритм:\n1. SELECT * FROM orders WHERE status = 'reserved' AND expires_at \u003c now().\n2. Для каждого expired order:\n   a. UPDATE orders SET status = 'expired'.\n   b. INSERT INTO point_ledger type = 'release'.\n   c. UPDATE wallets SET reserved = reserved - order.total_points.\n3. Логирование: сколько заказов expired.\n\nАльтернатива pg_cron: Supabase Edge Function вызываемая через cron.supabase.com или Vercel cron.\n\nТест: создать заказ, подождать TTL, проверить что баллы вернулись.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:53:42.471808+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:39:17.477426+03:00","closed_at":"2026-02-25T22:39:17.477426+03:00","close_reason":"Orders API, cart, HR dashboard, CSV import, employee list реализованы","dependencies":[{"issue_id":"benefit-market-94r.6","depends_on_id":"benefit-market-94r","type":"parent-child","created_at":"2026-02-25T21:53:42.472511+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-94r.7","title":"API: POST /api/import/employees — CSV-импорт","description":"Next.js API route POST /api/import/employees:\n\nДоступ: hr.\nContent-Type: multipart/form-data (файл CSV).\n\nФормат CSV:\nemail,name,grade,tenure_months,location,legal_entity\n\nАлгоритм:\n1. Парсинг CSV (papaparse).\n2. Валидация каждой строки через Zod.\n3. Для каждой валидной строки:\n   a. Upsert в users по email + tenant_id (создать если нет).\n   b. Upsert в employee_profiles.\n   c. Если новый сотрудник — создать wallet с balance = 0.\n4. Вернуть отчёт: { created: N, updated: N, errors: [{row: N, error: '...'}] }.\n\nЛимит: 1000 строк за раз. Обработка дубликатов email.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":150,"created_at":"2026-02-25T21:53:45.2027+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:39:17.539969+03:00","closed_at":"2026-02-25T22:39:17.539969+03:00","close_reason":"Orders API, cart, HR dashboard, CSV import, employee list реализованы","dependencies":[{"issue_id":"benefit-market-94r.7","depends_on_id":"benefit-market-94r","type":"parent-child","created_at":"2026-02-25T21:53:45.203365+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-94r.8","title":"UI: Страница импорта сотрудников","description":"Страница /dashboard/hr/import:\n\n1. Drag \u0026 drop зона для CSV файла (или кнопка выбора).\n2. Предпросмотр первых 5 строк перед импортом.\n3. Кнопка 'Импортировать'.\n4. Progress indicator во время загрузки.\n5. Результат: сводка (создано / обновлено / ошибки).\n6. Таблица ошибок: строка, поле, описание ошибки.\n7. Ссылка на скачивание шаблона CSV.\n\nshadcn/ui: Card, Table, Alert, Progress, Button.","status":"closed","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:53:47.738115+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:39:17.604458+03:00","closed_at":"2026-02-25T22:39:17.604458+03:00","close_reason":"Orders API, cart, HR dashboard, CSV import, employee list реализованы","dependencies":[{"issue_id":"benefit-market-94r.8","depends_on_id":"benefit-market-94r","type":"parent-child","created_at":"2026-02-25T21:53:47.738839+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-94r.9","title":"API: GET /api/reports/dashboard — данные HR-дашборда","description":"Next.js API route GET /api/reports/dashboard:\n\nДоступ: hr, admin.\n\nВозвращает агрегированные данные для tenant'а:\n1. Утилизация бюджета: total_accrued, total_spent, utilization_pct.\n2. Топ-5 популярных льгот: benefit_name, order_count, total_points.\n3. Активность сотрудников: total_employees, active (\u003e=1 заказ), inactive.\n4. Распределение по категориям: category_name, spent_points, pct.\n5. Динамика по месяцам (последние 6): month, accrued, spent.\n\nВсе запросы через SQL с группировкой. Кэширование не нужно для MVP.","status":"closed","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:53:50.212598+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:39:17.685624+03:00","closed_at":"2026-02-25T22:39:17.685624+03:00","close_reason":"Orders API, cart, HR dashboard, CSV import, employee list реализованы","dependencies":[{"issue_id":"benefit-market-94r.9","depends_on_id":"benefit-market-94r","type":"parent-child","created_at":"2026-02-25T21:53:50.216263+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-991","title":"5.1 Create error boundary component","description":"## 5.1 Create error boundary component\n\n### Файл\n`src/components/shared/error-boundary.tsx` (CREATE)\n\n### Что сделать\nReact class component (error boundaries требуют class components):\n```typescript\ninterface Props { children: React.ReactNode; fallback?: React.ReactNode }\ninterface State { hasError: boolean; error: Error | null }\n\nclass ErrorBoundary extends React.Component\u003cProps, State\u003e {\n  state = { hasError: false, error: null };\n  static getDerivedStateFromError(error) { return { hasError: true, error }; }\n  componentDidCatch(error, info) { console.error('ErrorBoundary caught:', error, info); }\n  handleRetry = () =\u003e { this.setState({ hasError: false, error: null }); };\n  render() {\n    if (this.state.hasError) {\n      return this.props.fallback || \u003cDefaultFallback error={this.state.error} onRetry={this.handleRetry} /\u003e;\n    }\n    return this.props.children;\n  }\n}\n```\n\nDefaultFallback UI: Card с иконкой AlertTriangle, заголовок 'Произошла ошибка', описание ошибки (в dev), кнопка 'Попробовать снова'.\n\n### Верификация\n- Компонент экспортируется\n- Ловит ошибки в children\n- Показывает fallback UI\n- Кнопка retry сбрасывает состояние","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-25T23:54:33.900808+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:09:22.89191+03:00","closed_at":"2026-02-26T00:09:22.89191+03:00","close_reason":"Closed"}
{"id":"benefit-market-9hx","title":"Epic 11: Testing","description":"## Epic 11: Testing\n\n### Задачи\n1. **Setup**: vitest, @testing-library/react, MSW, playwright, test factories\n2. **Unit tests**: condition-evaluator, order.service, wallet.service, cart store, errors\n3. **Component tests**: benefit-card, wallet-balance-card\n4. **Integration tests**: benefits API, orders API (с MSW)\n5. **E2E**: catalog flow, cart-checkout, orders, hr-dashboard, admin-crud (Playwright)\n\n### Зависимости\nЗависит от Epic 10 (финальный UI)\n\n### Верификация\n- `npm test` — all green\n- `npx playwright test` — all green\n- Coverage \u003e 60% для lib/","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-25T23:54:51.621828+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:49:24.125688+03:00","closed_at":"2026-02-26T00:49:24.125688+03:00","close_reason":"Vitest setup with 5 test files (39 tests all green): condition-evaluator, errors, cart store, eligibility, sanitize. Testing infrastructure with jsdom for component tests.","dependencies":[{"issue_id":"benefit-market-9hx","depends_on_id":"benefit-market-1d6","type":"blocks","created_at":"2026-02-25T23:59:27.245216+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-9il","title":"EPIC: Геймификация и вовлечение","description":"Бейджи и достижения за использование льгот, streak-механика, командные вызовы между отделами. Фокус на вовлечение, а НЕ на стимулирование траты всех баллов (работодатель платит — ему не нужен инструмент давления). Цель: сделать выбор льгот увлекательным процессом.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-27T08:36:39.483469+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:12:50.078496+03:00","closed_at":"2026-02-27T09:12:50.078496+03:00","close_reason":"Отклонено на этапе планирования — геймификация не нужна"}
{"id":"benefit-market-9mk","title":"2.1 Make benefit cards clickable","description":"## 2.1 Make benefit cards clickable\n\n### Файл\n`src/components/benefits/benefit-card.tsx`\n\n### Текущее состояние\nBenefitCard — это Card с CardHeader, CardContent, CardFooter. Нет Link/навигации. Единственное взаимодействие — кнопка 'Добавить'.\n\n### Что сделать\n1. Импортировать `Link` из `next/link`\n2. Обернуть CardHeader + CardContent в `\u003cLink href={\\`/dashboard/employee/catalog/${benefit.id}\\`}\u003e`\n3. Кнопку в CardFooter оставить снаружи Link (чтобы клик по кнопке не навигировал)\n4. Добавить cursor-pointer на кликабельную область\n\n### Верификация\n- Клик по названию/описанию → переход на детальную страницу\n- Клик по кнопке 'Добавить' → добавление в корзину (не навигация)\n- Hover state визуально различается","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-25T23:54:19.487671+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:02:59.585865+03:00","closed_at":"2026-02-26T00:02:59.585865+03:00","close_reason":"Closed"}
{"id":"benefit-market-9wj","title":"5.5 Fix category icon mapping (heart-pulse)","description":"## 5.5 Fix category icon mapping (heart-pulse)\n\n### Файлы\n- `src/components/benefits/category-filter.tsx`\n- `src/components/benefits/benefit-card.tsx`\n- `src/app/dashboard/employee/catalog/[id]/page.tsx`\n\n### Текущее состояние\nDemo data использует icon='heart-pulse' для категории 'Здоровье' (demo-cat-001), но iconMap во всех трёх файлах не содержит 'heart-pulse'. Категория рендерится с fallback иконкой Package.\n\n### Что сделать\nВ каждом из трёх файлов:\n1. Импортировать HeartPulse из lucide-react\n2. Добавить в iconMap: `'heart-pulse': HeartPulse`\n\n### Верификация\n- Категория 'Здоровье' отображается с иконкой HeartPulse (пульсирующее сердце)\n- В фильтре категорий, на карточке и на детальной странице","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-25T23:54:40.315829+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:09:22.903769+03:00","closed_at":"2026-02-26T00:09:22.903769+03:00","close_reason":"Closed"}
{"id":"benefit-market-a0w","title":"API + UI: обновлённый каталог сотрудника с маркетплейсом","description":"Обновить каталог сотрудника для поддержки marketplace-предложений наряду с legacy benefits.\n\nНОВЫЕ API:\n1. GET /api/offerings — подключённые marketplace-предложения для сотрудника\n   - requireAuth()\n   - Запрос: tenant_offerings WHERE tenant_id = current AND is_active = true\n   - JOIN provider_offerings (name, description, image_urls, avg_rating, review_count)\n   - JOIN providers (name, logo_url)\n   - JOIN global_categories (name, icon)\n   - Фильтры: category_id, search, sort (rating/price/name)\n   - Пагинация\n   - Eligibility checking через eligibility_rules WHERE tenant_offering_id = ...\n   - Цена: custom_price_points ?? base_price_points\n   - Рейтинги: оба — global (из provider_offerings) и company (из tenant_offerings)\n\n2. GET /api/offerings/[id] — детали с рейтингами\n   - tenant_offering + provider_offering + provider\n   - isEligible: boolean\n   - ratings: { global: { avg, count }, company: { avg, count } }\n   - Кошелёк: доступные баллы для проверки affordability\n\nUI ИЗМЕНЕНИЯ:\n- src/app/dashboard/employee/catalog/page.tsx:\n  - Запрашивать оба: /api/benefits (legacy) И /api/offerings (marketplace)\n  - Объединять в единый список\n  - Для marketplace-карточек показать: лого провайдера, рейтинг (★), кол-во отзывов\n\n- Новый/обновлённый компонент карточки:\n  - src/components/benefits/offering-card.tsx (или расширить benefit-card.tsx)\n  - Лого провайдера (small avatar)\n  - Рейтинг: ★4.5 (23 отзыва)\n  - Изображение предложения (если есть)\n  - Название + описание\n  - Цена в баллах\n  - Кнопка 'В корзину'\n\n- src/app/dashboard/employee/catalog/[id]/page.tsx:\n  - Определять тип (legacy benefit vs marketplace offering)\n  - Для marketplace: показать блок провайдера, условия, отзывы\n  - Двойной рейтинг: 'Общий 4.5★ от 847 пользователей' + 'В вашей компании 4.8★ от 23'\n  - Список последних отзывов (tenant-scoped)\n\nФайлы:\n- src/app/api/offerings/route.ts\n- src/app/api/offerings/[id]/route.ts\n- src/components/benefits/offering-card.tsx\n- src/app/dashboard/employee/catalog/page.tsx (обновить)\n- src/app/dashboard/employee/catalog/[id]/page.tsx (обновить)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T08:59:12.599975+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:20:35.226904+03:00","closed_at":"2026-02-27T09:20:35.226904+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-a0w","depends_on_id":"benefit-market-cu1","type":"blocks","created_at":"2026-02-27T09:00:41.074234+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-b0e","title":"1.1 Connect add-to-cart in catalog page","description":"## 1.1 Connect add-to-cart in catalog page\n\n### Файл\n`src/app/dashboard/employee/catalog/page.tsx` (lines 64-67)\n\n### Текущее состояние\n`handleAddToCart` содержит только `console.log('Add to cart:', benefit.id)` — ничего реально не добавляется.\n\n### Что сделать\n1. Импортировать `useCartStore` из `@/lib/store/cart`\n2. Импортировать `toast` из `sonner`\n3. Заменить console.log на:\n   - `useCartStore().addItem({ id, name, price_points, category_name, category_icon })`\n   - `toast.success(\\`${benefit.name} добавлен в корзину\\`)`\n\n### Верификация\n- Клик 'Добавить' в каталоге → товар появляется в корзине\n- Повторный клик → quantity увеличивается\n- Toast уведомление отображается","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-25T23:54:12.961758+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:02:20.783165+03:00","closed_at":"2026-02-26T00:02:20.783165+03:00","close_reason":"Closed"}
{"id":"benefit-market-b7k","title":"Epic 2: Catalog Navigation","description":"## Epic 2: Catalog Navigation\n\n### Контекст\nКарточки льгот в каталоге не кликабельны — только кнопка 'Добавить'. Пользователь не может перейти на детальную страницу кликом по карточке.\n\n### Задачи\n- 2.1 Make benefit cards clickable (benefit-market-9mk)\n\n### Верификация\n- Клик по карточке (header + content) → переход на /dashboard/employee/catalog/[id]\n- Клик по кнопке 'Добавить' → добавление в корзину (НЕ навигация)","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-25T23:54:17.799148+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:02:59.667021+03:00","closed_at":"2026-02-26T00:02:59.667021+03:00","close_reason":"Closed"}
{"id":"benefit-market-bi4","title":"EPIC: Маркетплейс провайдеров — из каталога в живую площадку","description":"Главный приоритет. Трансформация захардкоженного каталога льгот в полноценный маркетплейс, где провайдеры (фитнес-клубы, клиники, образовательные платформы) заводят свои предложения, управляют ими, а сотрудники ставят оценки и пишут отзывы. Сетевой эффект: больше провайдеров → больше ценности для работодателей → больше клиентов → больше провайдеров.","status":"open","priority":0,"issue_type":"feature","created_at":"2026-02-27T08:36:30.065924+03:00","created_by":"ayugunin","updated_at":"2026-02-27T08:36:30.065924+03:00"}
{"id":"benefit-market-bu5","title":"AI-чатбот: knowledge base и контекст компании","description":"Инфраструктура для хранения и получения контекста компании, который будет использоваться чатботом.\n\nОТКУДА БЕРЁТСЯ ИНФА О КОМПАНИИ:\n\n1. Structured data (автоматически из БД):\n   - Каталог подключённых льгот (tenant_offerings + provider_offerings)\n   - Категории и цены в баллах\n   - Баланс кошелька текущего пользователя\n   - Eligibility rules — кому что доступно\n   - Настройки тенанта (budget policies)\n\n2. FAQ компании (заводит HR):\n   НОВАЯ ТАБЛИЦА tenant_faq:\n   - id, tenant_id, question (text), answer (text), category (text), sort_order, is_active\n   - RLS: HR/admin CRUD, employee SELECT active\n   - Примеры:\n     'Когда начисляются баллы?' → 'Баллы начисляются 1 числа каждого месяца'\n     'Можно ли перенести баллы на следующий год?' → 'Нет, баллы сгорают 31 декабря'\n\n3. Документы компании (upload от HR):\n   НОВАЯ ТАБЛИЦА tenant_documents:\n   - id, tenant_id\n   - title (text) — название документа ('Политика льгот 2026')\n   - file_url (text) — ссылка на файл в Supabase Storage\n   - file_type: 'pdf' | 'docx' | 'txt'\n   - extracted_text (text) — извлечённый текст из документа\n   - status: 'processing' | 'ready' | 'error'\n   - uploaded_by (FK→users)\n   - created_at, updated_at\n   - RLS: HR/admin CRUD\n\n   FLOW загрузки:\n   a) HR загружает PDF/DOCX через UI\n   b) Файл сохраняется в Supabase Storage (bucket: tenant-documents)\n   c) Серверный endpoint извлекает текст:\n      - PDF: через pdf-parse (npm пакет)\n      - DOCX: через mammoth (npm пакет)\n      - TXT: напрямую\n   d) Извлечённый текст сохраняется в extracted_text\n   e) При запросе к чатботу: extracted_text подставляется в контекст промпта\n      (НЕ embeddings/RAG — простая подстановка текста, ограничение ~50к символов)\n   f) Если документов много — берём только активные, приоритизируем по дате\n\n   ОГРАНИЧЕНИЯ:\n   - Макс размер файла: 10MB\n   - Макс документов на тенант: 20\n   - Макс extracted_text: 100к символов (обрезаем с предупреждением)\n\nAPI:\n- CRUD /api/hr/faq — управление FAQ\n- GET /api/faq — FAQ для текущего тенанта (employee)\n- POST /api/hr/documents — загрузить документ (multipart/form-data)\n- GET /api/hr/documents — список документов\n- DELETE /api/hr/documents/[id] — удалить документ\n- POST /api/hr/documents/[id]/reprocess — переизвлечь текст\n\nСЕРВИС для сбора контекста:\n- src/lib/services/chatbot-context.service.ts:\n  - buildContext(userId, tenantId): string — собирает ВЕСЬ контекст для промпта\n  - Приоритет: structured data (всегда) + FAQ (всегда) + документы (если есть, до лимита токенов)\n  - Включает: баланс, доступные льготы (топ-20), FAQ, правила компании, тексты документов\n  - Форматирует как structured text для LLM\n  - Контролирует общий размер контекста (макс ~80к символов)\n\nUI для HR:\n- src/app/dashboard/hr/faq/page.tsx — управление FAQ (CRUD таблица)\n- src/app/dashboard/hr/documents/page.tsx — управление документами:\n  - Drag-n-drop загрузка файлов\n  - Список загруженных документов (название, тип, размер, статус, дата)\n  - Превью извлечённого текста\n  - Удаление\n\nФайлы:\n- supabase/migrations/00008_tenant_faq_and_documents.sql\n- src/app/api/hr/faq/route.ts\n- src/app/api/hr/faq/[id]/route.ts\n- src/app/api/faq/route.ts\n- src/app/api/hr/documents/route.ts\n- src/app/api/hr/documents/[id]/route.ts\n- src/lib/services/chatbot-context.service.ts\n- src/lib/services/document-extraction.service.ts\n- src/app/dashboard/hr/faq/page.tsx\n- src/app/dashboard/hr/documents/page.tsx","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-27T09:16:14.301858+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:36:38.148876+03:00"}
{"id":"benefit-market-c53","title":"API + UI: система отзывов и рейтингов","description":"Полная система отзывов: API + UI компоненты.\n\nAPI:\n1. POST /api/reviews — создать отзыв\n   - requireAuth() (employee)\n   - Валидация: createReviewSchema\n   - ПРОВЕРКИ:\n     a) У пользователя есть оплаченный заказ с этим offering (order_items.tenant_offering_id + orders.status=paid)\n     b) Ещё нет отзыва от этого пользователя (UNIQUE constraint)\n   - INSERT в reviews (tenant_id из текущего пользователя)\n   - Триггер в БД обновит агрегаты автоматически\n\n2. GET /api/reviews/offering/[offeringId] — отзывы для предложения\n   - Tenant-scoped (отзывы только из своей компании) + глобальная статистика\n   - Пагинация\n   - Сортировка: newest first\n   - Ответ: { reviews: [...], stats: { global: { avg, count }, company: { avg, count } } }\n\n3. PATCH /api/reviews/[id] — обновить свой отзыв\n   - Только автор (user_id = current)\n   - Можно менять rating, title, body\n\n4. DELETE /api/reviews/[id] — удалить свой отзыв\n   - Только автор\n\n5. GET /api/admin/reviews — модерация (admin only)\n   - Все отзывы, фильтр по status (visible/hidden/flagged)\n   - Пагинация\n\n6. PATCH /api/admin/reviews/[id] — модерировать\n   - Менять status (hide/restore/flag)\n   - moderated_by, moderated_at\n\nUI КОМПОНЕНТЫ:\n- src/components/reviews/review-card.tsx — карточка отзыва (аватар, рейтинг звёзды, текст, дата)\n- src/components/reviews/review-form.tsx — форма отзыва (рейтинг звёзды + текст)\n- src/components/reviews/rating-display.tsx — отображение рейтинга (★4.5 от 23)\n- src/components/reviews/review-list.tsx — список отзывов с пагинацией\n\nИнтеграция:\n- Страница деталей предложения: показать отзывы + кнопка 'Оставить отзыв'\n- Страница истории заказов: кнопка 'Оставить отзыв' для оплаченных заказов\n\nФайлы:\n- src/app/api/reviews/route.ts\n- src/app/api/reviews/offering/[offeringId]/route.ts\n- src/app/api/reviews/[id]/route.ts\n- src/app/api/admin/reviews/route.ts\n- src/app/api/admin/reviews/[id]/route.ts\n- src/components/reviews/*.tsx","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-27T08:59:40.297825+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:22:52.399022+03:00","closed_at":"2026-02-27T09:22:52.399022+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-c53","depends_on_id":"benefit-market-79o","type":"blocks","created_at":"2026-02-27T09:00:43.235336+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-cm7","title":"Auth и middleware: роль провайдера","description":"Обновить систему аутентификации для поддержки роли provider.\n\n1. src/middleware.ts:\n- Добавить проверку /dashboard/provider/* → только role=provider или admin\n- Обновить getDashboardByRole(): provider → /dashboard/provider\n- Добавить provider в маппинг ролей\n\n2. src/app/(auth)/register/page.tsx:\n- Добавить 'Провайдер' в выпадающий список ролей\n- При выборе provider: tenant_id = PLATFORM_TENANT_ID (00000000-0000-0000-0000-000000000000)\n\n3. src/lib/api/auth.ts:\n- Убедиться что requireRole() корректно работает с 'provider'\n\n4. Константа PLATFORM_TENANT_ID: добавить в src/lib/constants.ts или аналог.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-27T08:57:41.650975+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:15:57.978223+03:00","closed_at":"2026-02-27T09:15:57.978223+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-cm7","depends_on_id":"benefit-market-6b1","type":"blocks","created_at":"2026-02-27T08:58:02.455954+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-cm7","depends_on_id":"benefit-market-ctr","type":"blocks","created_at":"2026-02-27T08:58:06.707477+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-cmu","title":"1.3 Fix wallet data normalization in cart page","description":"## 1.3 Fix wallet data normalization in cart page\n\n### Файл\n`src/app/dashboard/employee/cart/page.tsx` (line 51)\n\n### Текущее состояние\n`setWallet(json.data)` — но API /wallets/me возвращает разные форматы:\n- **Demo mode**: `{ data: { wallet: { balance, reserved, ... }, ledger: [...] } }`\n- **Real mode**: `{ data: { balance, reserved, available, ... } }`\n\nCart page ожидает `{ balance, reserved, available }`, но в demo получает вложенный объект.\n\n### Что сделать\nНормализовать ответ:\n```typescript\nconst d = json.data;\nif (d.wallet) {\n  // demo mode\n  setWallet({ balance: d.wallet.balance, reserved: d.wallet.reserved, available: d.wallet.balance - d.wallet.reserved });\n} else {\n  // real mode\n  setWallet(d);\n}\n```\n\n### Верификация\n- В demo mode баланс отображается корректно (45000 б., доступно 39000 б.)\n- В real mode баланс отображается корректно\n- Warning 'Недостаточно баллов' работает при превышении","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-25T23:54:16.286106+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:02:20.917133+03:00","closed_at":"2026-02-26T00:02:20.917133+03:00","close_reason":"Closed"}
{"id":"benefit-market-ctr","title":"Feature flags и error codes для маркетплейса","description":"1. src/lib/feature-flags.ts — добавить:\n- ENABLE_MARKETPLACE (env: NEXT_PUBLIC_FF_MARKETPLACE, default false)\n- ENABLE_PROVIDER_REGISTRATION (env: NEXT_PUBLIC_FF_PROVIDER_REGISTRATION, default false)\n- ENABLE_REVIEWS (env: NEXT_PUBLIC_FF_REVIEWS, default false)\n\n2. src/lib/errors.ts — добавить error codes:\n- PROVIDER_NOT_FOUND\n- PROVIDER_NOT_VERIFIED\n- OFFERING_NOT_PUBLISHED\n- ALREADY_REVIEWED\n- REVIEW_NOT_ALLOWED\n- DUPLICATE_TENANT_OFFERING","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T08:57:36.03722+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:13:42.778227+03:00","closed_at":"2026-02-27T09:13:42.778227+03:00","close_reason":"Closed"}
{"id":"benefit-market-cu1","title":"API + UI: HR-маркетплейс и курация предложений","description":"HR-функционал для обзора глобального маркетплейса и подключения предложений.\n\nМАРКЕТПЛЕЙС API:\n1. GET /api/hr/marketplace — обзор глобальных published предложений\n   - requireRole('hr', 'admin')\n   - Запрос: provider_offerings WHERE status=published JOIN providers WHERE status=verified\n   - Использовать admin client (кросс-тенантный запрос)\n   - Фильтры: global_category_id, search, sort (rating/price/newest)\n   - Пагинация\n   - Для каждого: пометка 'уже подключено' (LEFT JOIN tenant_offerings WHERE tenant_id = current)\n   - Данные: имя, описание, провайдер (name, logo), категория, base_price_points, avg_rating, review_count\n\n2. GET /api/hr/marketplace/[offeringId] — детали предложения\n   - Полное описание, условия, информация о доставке\n   - Провайдер: имя, описание, рейтинг, верификация\n   - Уже подключено? (+ настройки если да)\n\nКУРАЦИЯ API:\n3. POST /api/hr/offerings — подключить предложение для своей компании\n   - Валидация: enableTenantOfferingSchema\n   - Проверка: offering exists + published + provider verified\n   - Проверка: не дубликат (UNIQUE constraint)\n   - INSERT в tenant_offerings\n   - enabled_by = current user id\n\n4. GET /api/hr/offerings — список подключённых\n   - tenant_offerings WHERE tenant_id = current\n   - JOIN provider_offerings, providers\n   - Показать: кастомную цену, активность, рейтинги\n\n5. PATCH /api/hr/offerings/[id] — обновить настройки\n   - custom_price_points, tenant_stock_limit, is_active, tenant_category_id\n\n6. DELETE /api/hr/offerings/[id] — отключить\n   - Мягкое удаление (is_active = false) или полное удаление\n\nUI СТРАНИЦЫ:\n- src/app/dashboard/hr/marketplace/page.tsx\n  - Грид предложений с карточками\n  - Фильтры: категория, поиск, сортировка\n  - На карточке: лого провайдера, название, цена, рейтинг, 'Подключить' / 'Уже подключено'\n  - Модал подключения: настроить цену в баллах, stock limit, категорию\n\n- src/app/dashboard/hr/offerings/page.tsx\n  - Таблица подключённых предложений\n  - Колонки: название, провайдер, кастомная цена, статус, рейтинг\n  - Действия: редактировать настройки, отключить\n\nФайлы:\n- src/app/api/hr/marketplace/route.ts\n- src/app/api/hr/marketplace/[offeringId]/route.ts\n- src/app/api/hr/offerings/route.ts (GET, POST)\n- src/app/api/hr/offerings/[id]/route.ts (PATCH, DELETE)\n- src/app/dashboard/hr/marketplace/page.tsx\n- src/app/dashboard/hr/offerings/page.tsx","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T08:58:56.498319+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:20:35.159752+03:00","closed_at":"2026-02-27T09:20:35.159752+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-cu1","depends_on_id":"benefit-market-91x","type":"blocks","created_at":"2026-02-27T09:00:40.664778+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-cu1","depends_on_id":"benefit-market-itu","type":"blocks","created_at":"2026-02-27T09:00:40.837137+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-de4","title":"5.4 Demo mode for confirm/cancel orders","description":"## 5.4 Demo mode for confirm/cancel orders\n\n### Файлы\n- `src/app/api/orders/[id]/confirm/route.ts`\n- `src/app/api/orders/[id]/cancel/route.ts`\n\n### Текущее состояние\nОба route обращаются к Supabase для auth и data — в demo mode нет реального auth, поэтому confirm/cancel возвращают 401.\n\n### Что сделать\nДобавить demo mode обработку в начало каждого POST handler (по паттерну других routes):\n\n**confirm/route.ts:**\n```typescript\nif (process.env.NEXT_PUBLIC_DEMO_MODE === 'true') {\n  const { id: orderId } = await params;\n  return NextResponse.json({\n    data: { id: orderId, status: 'paid', total_points: 0, user_id: 'demo-user-001', tenant_id: 'demo-tenant-001', reserved_at: new Date().toISOString(), expires_at: new Date().toISOString(), created_at: new Date().toISOString() }\n  });\n}\n```\n\n**cancel/route.ts:** аналогично, но status: 'cancelled'.\n\n### Верификация\n- В demo mode: confirm → 200 с status 'paid'\n- В demo mode: cancel → 200 с status 'cancelled'\n- В real mode: поведение не изменилось","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-25T23:54:38.819267+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:09:22.90191+03:00","closed_at":"2026-02-26T00:09:22.90191+03:00","close_reason":"Closed"}
{"id":"benefit-market-dlq","title":"Database migration: таблицы маркетплейса (00004)","description":"Создать миграцию supabase/migrations/00004_provider_marketplace.sql со всеми новыми таблицами и изменениями.\n\nНОВЫЕ ENUM:\n- provider_status: pending | verified | suspended | rejected\n- offering_status: draft | pending_review | published | archived\n- review_status: visible | hidden | flagged\n- Добавить 'provider' в user_role\n\nНОВЫЕ ТАБЛИЦЫ:\n1. providers (глобальная, БЕЗ tenant_id): id, owner_user_id, name, slug (unique), description, logo_url, website, contact_email, contact_phone, address, status (provider_status), verified_at, verified_by, rejection_reason, metadata (jsonb), created_at, updated_at\n2. global_categories: id, name (unique), icon, sort_order, is_active, created_at\n3. provider_offerings (глобальная): id, provider_id (FK→providers), global_category_id (FK→global_categories), name, description, long_description, image_urls (text[]), base_price_points (CHECK \u003e0), stock_limit, status (offering_status), delivery_info, terms_conditions, metadata (jsonb), avg_rating (numeric 3,2), review_count (int), created_at, updated_at\n4. tenant_offerings: id, tenant_id (FK→tenants), provider_offering_id (FK→provider_offerings), custom_price_points (nullable), tenant_stock_limit (nullable), is_active, tenant_category_id (FK→benefit_categories), enabled_by (FK→users), enabled_at, tenant_avg_rating, tenant_review_count, metadata. UNIQUE(tenant_id, provider_offering_id)\n5. reviews: id, provider_offering_id (FK), tenant_id (FK), user_id (FK), order_id (FK, nullable), rating (1-5), title, body, status (review_status), moderated_by, moderated_at, created_at, updated_at. UNIQUE(user_id, provider_offering_id)\n6. provider_users: id, provider_id (FK), user_id (FK), role (owner|admin|member), created_at. UNIQUE(provider_id, user_id)\n\nИЗМЕНЕНИЯ СУЩЕСТВУЮЩИХ:\n- order_items: +provider_offering_id (nullable FK), +tenant_offering_id (nullable FK)\n- eligibility_rules: +tenant_offering_id (nullable FK), benefit_id стать nullable. CHECK: ровно одно из benefit_id или tenant_offering_id NOT NULL\n- benefit_categories: +global_category_id (nullable FK)\n\nPLATFORM TENANT:\n- INSERT INTO tenants с id='00000000-0000-0000-0000-000000000000', name='Platform'\n\nИНДЕКСЫ: на все FK, частичные индексы на status='published', rating DESC.\n\nRLS ПОЛИТИКИ:\n- providers: verified видны всем, owner видит свой, admin видит все\n- global_categories: SELECT всем, CUD только admin\n- provider_offerings: published видны всем, provider видит свои, admin видит все\n- tenant_offerings: стандартная tenant-изоляция\n- reviews: tenant-scoped SELECT + admin видит все\n- provider_users: owner/admin провайдера видит своих\n\nTRIGGER: update_review_aggregates() на INSERT/UPDATE/DELETE reviews → обновляет avg_rating/review_count в provider_offerings и tenant_offerings","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-27T08:57:18.392801+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:13:42.775824+03:00","closed_at":"2026-02-27T09:13:42.775824+03:00","close_reason":"Closed"}
{"id":"benefit-market-dpv","title":"AI-чатбот: Chat API с Claude","description":"Серверная часть чатбота: интеграция с Claude API.\n\nAPI:\n- POST /api/chat — отправить сообщение чатботу\n  - Body: { message: string, conversation_id?: string }\n  - requireAuth() (employee)\n  - Логика:\n    1. Получить контекст компании (chatbot-context.service.ts)\n    2. Загрузить историю диалога (если conversation_id)\n    3. Составить промпт: system (роль + контекст) + history + user message\n    4. Вызвать Claude API (stream)\n    5. Сохранить сообщение и ответ в историю\n    6. Вернуть ответ (streaming)\n\nХРАНЕНИЕ ИСТОРИИ:\nНОВАЯ ТАБЛИЦА chat_conversations:\n- id, user_id (FK), tenant_id, title (auto-generated), created_at, updated_at\n\nНОВАЯ ТАБЛИЦА chat_messages:\n- id, conversation_id (FK), role: 'user' | 'assistant', content (text), created_at\n\nRLS: пользователь видит только свои диалоги.\n\nSYSTEM PROMPT:\n'Ты — виртуальный HR-ассистент компании {companyName}. Ты помогаешь сотрудникам с вопросами о льготах и бенефитах.\n\nИнформация о компании:\n{context}\n\nПравила:\n- Отвечай кратко и по делу\n- Если не знаешь ответа — честно скажи и предложи обратиться в HR\n- Не придумывай информацию, которой нет в контексте\n- Можешь рекомендовать льготы из каталога на основе вопроса пользователя\n- Отвечай на русском языке'\n\nENV:\n- ANTHROPIC_API_KEY — ключ Claude API\n\nФайлы:\n- supabase/migrations/00009_chat.sql\n- src/app/api/chat/route.ts (streaming response)\n- src/lib/services/chat.service.ts\n- .env.example (добавить ANTHROPIC_API_KEY)","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-27T09:16:22.602815+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:16:22.602815+03:00","dependencies":[{"issue_id":"benefit-market-dpv","depends_on_id":"benefit-market-bu5","type":"blocks","created_at":"2026-02-27T09:17:07.33875+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-dvc","title":"Epic 14: Performance","description":"## Epic 14: Performance\n\n### Задачи\n1. **DB indexes** — `supabase/migrations/004_add_indexes.sql`: 10 индексов для частых queries\n2. **Parallel queries** — Promise.all() в dashboard services\n3. **DB-level pagination** — серверная пагинация для benefits API (сейчас клиентская)\n4. **Code splitting** — React.lazy() для chart-компонентов (recharts тяжёлый)\n5. **Feature flags** — `src/lib/feature-flags.ts`: простая система feature flags\n\n### Верификация\n- Dashboard загружается быстрее (параллельные queries)\n- Benefits API поддерживает server-side pagination\n- Chart bundle отложен (lazy load)\n- Feature flags работают","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-25T23:54:56.69474+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:54:31.450022+03:00","closed_at":"2026-02-26T00:54:31.450022+03:00","close_reason":"Added 8 supplementary DB indexes, lazy-loaded recharts charts via next/dynamic, created feature flags module. Dashboard already used Promise.all for parallel queries. All checks pass.","dependencies":[{"issue_id":"benefit-market-dvc","depends_on_id":"benefit-market-83x","type":"blocks","created_at":"2026-02-25T23:59:28.081364+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-ed5","title":"Epic 1: Cart Integration Fix","description":"## Epic 1: Cart Integration Fix\n\n**Приоритет**: P0 — без этого приложение не функционирует\n\n### Контекст\nКорзина не работает: в каталоге console.log вместо реального addItem, на детальной странице кнопка без onClick, в корзине баланс кошелька не нормализуется между demo и real режимами.\n\n### Задачи\n- 1.1 Connect add-to-cart in catalog page (benefit-market-b0e)\n- 1.2 Connect add-to-cart on detail page (benefit-market-t2x)\n- 1.3 Fix wallet data normalization in cart page (benefit-market-cmu)\n\n### Верификация\n- build passes\n- Добавление в корзину работает с обеих страниц (каталог + детальная)\n- Баланс в корзине корректен в demo и real режимах\n- toast уведомления при добавлении","status":"closed","priority":0,"issue_type":"feature","created_at":"2026-02-25T23:54:11.178161+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:02:20.983958+03:00","closed_at":"2026-02-26T00:02:20.983958+03:00","close_reason":"Closed"}
{"id":"benefit-market-g4i","title":"EPIC: Peer Recognition — благодарности между коллегами","description":"Коллеги благодарят друг друга с начислением бонусных баллов. Публичная стена благодарностей. Связка с корпоративной культурой. Бюджет на признание выделяется отдельно от основного бюджета льгот.","status":"open","priority":3,"issue_type":"feature","created_at":"2026-02-27T08:36:48.351134+03:00","created_by":"ayugunin","updated_at":"2026-02-27T08:36:48.351134+03:00"}
{"id":"benefit-market-gjz","title":"5.2 Wrap dashboard layout with ErrorBoundary","description":"## 5.2 Wrap dashboard layout with ErrorBoundary\n\n### Файл\n`src/app/dashboard/layout.tsx`\n\n### Текущее состояние\nChildren рендерятся напрямую в SidebarInset без error boundary.\n\n### Что сделать\n1. Импортировать ErrorBoundary из '@/components/shared/error-boundary'\n2. Обернуть {children} в \u003cErrorBoundary\u003e:\n```tsx\n\u003cSidebarInset\u003e\n  \u003cErrorBoundary\u003e\n    {children}\n  \u003c/ErrorBoundary\u003e\n\u003c/SidebarInset\u003e\n```\n\nВажно: ErrorBoundary — client component, layout — server component. Нужно убедиться что 'use client' в error-boundary.tsx НЕ нужен (class component работает и так), или использовать dynamic import.\n\n### Верификация\n- Ошибка в любой dashboard странице → fallback UI вместо белого экрана\n- Sidebar остаётся доступным\n- Retry работает","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-25T23:54:35.572708+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:09:22.897478+03:00","closed_at":"2026-02-26T00:09:22.897478+03:00","close_reason":"Closed"}
{"id":"benefit-market-gp6","title":"5.3 Cart badge in sidebar","description":"## 5.3 Cart badge in sidebar\n\n### Файл\n`src/components/layout/app-sidebar.tsx`\n\n### Зависимости\nЗависит от Epic 1 (корзина должна работать)\n\n### Текущее состояние\nПункт 'Корзина' в employee sidebar без индикатора количества товаров.\n\n### Что сделать\n1. Импортировать useCartStore из '@/lib/store/cart'\n2. Получить items из стора\n3. Для пункта 'Корзина' добавить Badge с количеством:\n```tsx\n\u003cSidebarMenuButton asChild isActive={isActive} tooltip={item.title}\u003e\n  \u003cLink href={item.href}\u003e\n    \u003citem.icon /\u003e\n    \u003cspan\u003e{item.title}\u003c/span\u003e\n    {item.href === '/dashboard/employee/cart' \u0026\u0026 cartCount \u003e 0 \u0026\u0026 (\n      \u003cBadge variant='secondary' className='ml-auto size-5 justify-center rounded-full p-0 text-xs'\u003e\n        {cartCount}\n      \u003c/Badge\u003e\n    )}\n  \u003c/Link\u003e\n\u003c/SidebarMenuButton\u003e\n```\n\n### Верификация\n- Badge появляется когда в корзине есть товары\n- Badge обновляется при добавлении/удалении\n- Badge скрывается при пустой корзине\n- Badge не появляется в HR/Admin sidebar","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-25T23:54:37.225203+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:09:22.900211+03:00","closed_at":"2026-02-26T00:09:22.900211+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-gp6","depends_on_id":"benefit-market-b0e","type":"blocks","created_at":"2026-02-25T23:55:17.698322+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-gp6","depends_on_id":"benefit-market-t2x","type":"blocks","created_at":"2026-02-25T23:55:19.316937+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-hwg","title":"Тестирование и деплой","description":"Недели 9-10. E2E тесты (Playwright), базовое нагрузочное тестирование, документация для защиты, деплой демо-стенда.","status":"in_progress","priority":2,"issue_type":"epic","created_at":"2026-02-25T21:50:56.264555+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:46:18.142527+03:00","dependencies":[{"issue_id":"benefit-market-hwg","depends_on_id":"benefit-market-1a0","type":"blocks","created_at":"2026-02-25T21:55:13.523472+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-hwg.1","title":"E2E тесты: авторизация и роли","description":"Playwright E2E тесты:\n\n1. Регистрация нового пользователя.\n2. Вход с email + пароль.\n3. Редирект employee на /dashboard/employee.\n4. Редирект HR на /dashboard/hr.\n5. Редирект admin на /dashboard/admin.\n6. Employee не может открыть /dashboard/admin → редирект.\n7. HR не может открыть /dashboard/admin → редирект.\n8. Неавторизованный → /auth/login.\n\nFixtures: тестовые пользователи из seed-данных.\nCI: запуск на GitHub Actions.","status":"open","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:54:38.806164+03:00","created_by":"ayugunin","updated_at":"2026-02-25T21:54:38.806164+03:00","dependencies":[{"issue_id":"benefit-market-hwg.1","depends_on_id":"benefit-market-hwg","type":"parent-child","created_at":"2026-02-25T21:54:38.806836+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-hwg.2","title":"E2E тесты: покупка льготы (happy path)","description":"Playwright E2E тесты:\n\n1. Войти как employee.\n2. Открыть каталог, увидеть доступные льготы.\n3. Кликнуть на льготу → детальная страница.\n4. Добавить в корзину.\n5. Перейти в корзину, проверить итого.\n6. Оформить заказ → статус reserved.\n7. Подтвердить заказ → статус paid.\n8. Проверить баланс кошелька уменьшился.\n9. Проверить заказ в истории заказов.\n\nТест отмены:\n10. Создать заказ → cancel → баланс вернулся.","status":"open","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:54:42.067074+03:00","created_by":"ayugunin","updated_at":"2026-02-25T21:54:42.067074+03:00","dependencies":[{"issue_id":"benefit-market-hwg.2","depends_on_id":"benefit-market-hwg","type":"parent-child","created_at":"2026-02-25T21:54:42.067626+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-hwg.3","title":"E2E тесты: HR-импорт и дашборд","description":"Playwright E2E тесты:\n\n1. Войти как HR.\n2. Открыть страницу импорта.\n3. Загрузить тестовый CSV (fixtures/test-employees.csv).\n4. Проверить отчёт: N создано, M обновлено.\n5. Перейти в список сотрудников — новые сотрудники появились.\n6. Открыть дашборд — графики отображаются.\n7. Тест ошибок импорта: загрузить невалидный CSV → показать ошибки.","status":"open","priority":3,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-25T21:54:44.984435+03:00","created_by":"ayugunin","updated_at":"2026-02-25T21:54:44.984435+03:00","dependencies":[{"issue_id":"benefit-market-hwg.3","depends_on_id":"benefit-market-hwg","type":"parent-child","created_at":"2026-02-25T21:54:44.985068+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-hwg.4","title":"Нагрузочное тестирование (k6)","description":"Базовое нагрузочное тестирование с k6:\n\nСценарии:\n1. Каталог льгот: 100 VU, 30s — GET /api/benefits.\n2. Создание заказа: 50 VU, 30s — POST /api/orders.\n3. Смешанный: 100 VU (70% каталог, 20% заказы, 10% кошелёк), 60s.\n\nПроверки:\n- p95 \u003c 500ms.\n- Error rate \u003c 1%.\n- Нет deadlock'ов при параллельных заказах.\n\nОтчёт: summary в markdown для дипломной работы.","status":"open","priority":3,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-25T21:54:48.048772+03:00","created_by":"ayugunin","updated_at":"2026-02-25T21:54:48.048772+03:00","dependencies":[{"issue_id":"benefit-market-hwg.4","depends_on_id":"benefit-market-hwg","type":"parent-child","created_at":"2026-02-25T21:54:48.049368+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-hwg.5","title":"Документация для защиты диплома","description":"Подготовить:\n\n1. Обновить README.md по итогам реализации (актуализировать если что-то изменилось).\n2. Описание архитектурных решений и обоснования (для текста диплома):\n   - Почему Next.js + Supabase.\n   - Почему shared schema multi-tenancy.\n   - Почему point_ledger (event sourcing lite).\n   - Сравнение с аналогами.\n3. Скриншоты ключевых экранов.\n4. Результаты нагрузочного тестирования.\n5. Описание ограничений MVP и план развития.","status":"open","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:54:51.688842+03:00","created_by":"ayugunin","updated_at":"2026-02-25T21:54:51.688842+03:00","dependencies":[{"issue_id":"benefit-market-hwg.5","depends_on_id":"benefit-market-hwg","type":"parent-child","created_at":"2026-02-25T21:54:51.689603+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-hwg.6","title":"Деплой демо-стенда","description":"Развернуть рабочий демо:\n\n1. Деплой Next.js на Vercel (или аналог).\n2. Supabase project для демо (отдельный от dev).\n3. Seed-данные: тестовая компания, 20+ сотрудников, 15+ льгот.\n4. Тестовые учётные записи: employee / hr / admin (пароли в .env).\n5. README с инструкцией как зайти и протестировать.\n6. Проверить всё работает: регистрация, каталог, заказ, импорт, дашборд.","status":"open","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:54:53.717213+03:00","created_by":"ayugunin","updated_at":"2026-02-25T21:54:53.717213+03:00","dependencies":[{"issue_id":"benefit-market-hwg.6","depends_on_id":"benefit-market-hwg","type":"parent-child","created_at":"2026-02-25T21:54:53.717813+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-itu","title":"API: CRUD предложений провайдера","description":"CRUD для управления предложениями провайдера.\n\nРОУТЫ:\n1. GET /api/provider/offerings — список своих предложений (все статусы)\n   - requireRole('provider')\n   - Фильтры: status, category, search\n   - Пагинация\n   - JOIN global_categories для имени/иконки\n\n2. POST /api/provider/offerings — создать новое (status=draft)\n   - Валидация: createProviderOfferingSchema\n   - provider_id из текущего провайдера пользователя\n   - Проверка: провайдер верифицирован (status=verified)\n\n3. GET /api/provider/offerings/[id] — детали предложения\n   - Только своё (проверка provider_id)\n   - Включает рейтинг, кол-во заказов\n\n4. PATCH /api/provider/offerings/[id] — обновить\n   - Только своё\n   - Валидация: updateProviderOfferingSchema\n   - Нельзя менять status через этот роут\n   - Если status=published → при изменении цены уведомить (аудит)\n\n5. POST /api/provider/offerings/[id]/submit — отправить на модерацию\n   - Только draft → pending_review\n   - Проверка: все обязательные поля заполнены (name, description, base_price_points, global_category_id)\n\n6. DELETE /api/provider/offerings/[id] — архивировать\n   - Меняет status → archived\n   - Мягкое удаление\n\nФайлы:\n- src/app/api/provider/offerings/route.ts (GET, POST)\n- src/app/api/provider/offerings/[id]/route.ts (GET, PATCH, DELETE)\n- src/app/api/provider/offerings/[id]/submit/route.ts (POST)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T08:58:08.534714+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:17:40.705431+03:00","closed_at":"2026-02-27T09:17:40.705431+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-itu","depends_on_id":"benefit-market-5bu","type":"blocks","created_at":"2026-02-27T09:00:37.264319+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-iv8","title":"Epic 5: Error Boundary and Polish","description":"## Epic 5: Error Boundary \u0026 Polish\n\n### Контекст\nПриложение не имеет error boundary — любая ошибка в рендере ломает весь dashboard. Нет badge корзины в сайдбаре, confirm/cancel заказов не работают в demo mode, иконка heart-pulse не маппится, HR не может экспортировать данные.\n\n### Задачи\n- 5.1 Create error boundary component (benefit-market-991)\n- 5.2 Wrap dashboard layout with ErrorBoundary (benefit-market-gjz)\n- 5.3 Cart badge in sidebar (benefit-market-gp6) — зависит от Epic 1\n- 5.4 Demo mode for confirm/cancel orders (benefit-market-de4)\n- 5.5 Fix category icon mapping heart-pulse (benefit-market-9wj)\n- 5.6 HR dashboard CSV export (benefit-market-7l7)\n\n### Верификация\n- Error boundary ловит ошибки и показывает fallback UI с retry\n- Badge корзины обновляется при добавлении товаров\n- Confirm/cancel работают в demo mode\n- Иконка heart-pulse рендерится для категории Здоровье\n- CSV скачивается с данными дашборда","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-25T23:54:32.201078+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:09:22.907242+03:00","closed_at":"2026-02-26T00:09:22.907242+03:00","close_reason":"Closed"}
{"id":"benefit-market-ivk","title":"Каталог льгот и кошельки баллов","description":"Недели 3-4. Каталог льгот с фильтрацией по eligibility rules, кошельки сотрудников, система баллов (budget policies, accrual), отображение баланса и истории транзакций.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-02-25T21:50:50.294863+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:31:07.534035+03:00","closed_at":"2026-02-25T22:31:07.534035+03:00","close_reason":"Каталог и кошельки полностью готовы","dependencies":[{"issue_id":"benefit-market-ivk","depends_on_id":"benefit-market-73a","type":"blocks","created_at":"2026-02-25T21:55:12.874469+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-ivk.1","title":"API: GET /api/benefits — каталог с фильтрацией","description":"Next.js API route GET /api/benefits:\n\n1. Извлечь user_id и tenant_id из JWT.\n2. Загрузить employee_profile текущего пользователя.\n3. Запросить benefits WHERE tenant_id AND is_active = true.\n4. Для каждой льготы проверить eligibility_rules.conditions против профиля (grade, tenure, location).\n5. Вернуть отфильтрованный список с пагинацией.\n\nQuery params: ?category_id=, ?search=, ?page=, ?per_page=\nResponse: { data: Benefit[], meta: { page, per_page, total } }\n\nZod-схема для query params. Обработка ошибок.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:52:47.126773+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:31:07.216906+03:00","closed_at":"2026-02-25T22:31:07.216906+03:00","close_reason":"API + UI каталога, кошелька, eligibility, budget policies реализованы","dependencies":[{"issue_id":"benefit-market-ivk.1","depends_on_id":"benefit-market-ivk","type":"parent-child","created_at":"2026-02-25T21:52:47.127379+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-ivk.2","title":"UI: Страница каталога льгот с карточками","description":"Страница /dashboard/employee/benefits:\n\n- Шапка: поисковая строка + фильтр по категориям (tabs или select).\n- Сетка карточек: изображение/иконка, название, краткое описание, цена в баллах, категория.\n- Состояния: загрузка (skeleton), пустой результат, ошибка.\n- Пагинация или infinite scroll.\n- Клик по карточке → переход на детальную страницу.\n- Компоненты: BenefitCard, BenefitGrid, CategoryFilter, SearchInput.\n\nИспользовать shadcn/ui Card, Input, Tabs, Skeleton.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":150,"created_at":"2026-02-25T21:52:49.585866+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:31:07.277511+03:00","closed_at":"2026-02-25T22:31:07.277511+03:00","close_reason":"API + UI каталога, кошелька, eligibility, budget policies реализованы","dependencies":[{"issue_id":"benefit-market-ivk.2","depends_on_id":"benefit-market-ivk","type":"parent-child","created_at":"2026-02-25T21:52:49.586489+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-ivk.3","title":"UI: Детальная страница льготы","description":"Страница /dashboard/employee/benefits/[id]:\n\n- Полное описание льготы (rich text или markdown).\n- Цена в баллах (крупно).\n- Оставшийся stock (если есть лимит).\n- Кнопка 'Добавить в корзину' / 'В корзине'.\n- Показать текущий баланс кошелька для контекста.\n- Хлебные крошки: Каталог \u003e Категория \u003e Льгота.\n- Состояние если льгота недоступна (eligibility не пройдена) — показать 'Недоступна' без кнопки.\n\nAPI: GET /api/benefits/:id","status":"closed","priority":2,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-25T21:52:51.920249+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:31:07.282096+03:00","closed_at":"2026-02-25T22:31:07.282096+03:00","close_reason":"API + UI каталога, кошелька, eligibility, budget policies реализованы","dependencies":[{"issue_id":"benefit-market-ivk.3","depends_on_id":"benefit-market-ivk","type":"parent-child","created_at":"2026-02-25T21:52:51.920912+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-ivk.4","title":"Движок eligibility rules","description":"Реализовать проверку eligibility в lib/eligibility.ts:\n\nФункция: checkEligibility(profile: EmployeeProfile, rules: EligibilityRule[]): boolean\n\nФормат conditions (JSONB):\n{\n  grade: ['senior', 'middle'],  // IN check\n  min_tenure: 6,                // \u003e= check\n  location: ['Moscow', 'SPb'],  // IN check\n  legal_entity: ['ООО Тест']    // IN check\n}\n\nЛогика: ВСЕ условия должны быть true (AND). Если conditions пуст — льгота доступна всем.\nЕсли у benefit нет eligibility_rules — доступна всем.\n\nUnit-тесты для всех комбинаций.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-25T21:52:54.161037+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:31:07.2842+03:00","closed_at":"2026-02-25T22:31:07.2842+03:00","close_reason":"API + UI каталога, кошелька, eligibility, budget policies реализованы","dependencies":[{"issue_id":"benefit-market-ivk.4","depends_on_id":"benefit-market-ivk","type":"parent-child","created_at":"2026-02-25T21:52:54.161629+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-ivk.5","title":"API: GET /api/wallets/me — баланс и история","description":"Next.js API route GET /api/wallets/me:\n\n1. Извлечь user_id из JWT.\n2. Найти активный wallet (текущий период, expires_at \u003e now()).\n3. Вернуть: balance, reserved, available (balance - reserved), period, expires_at.\n4. Вместе с последними N записями из point_ledger.\n\nQuery params: ?include_history=true, ?history_limit=50\nResponse: { data: { balance, reserved, available, period, expires_at, history?: LedgerEntry[] } }\n\nЕсли кошелька нет — вернуть balance: 0.","status":"closed","priority":1,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-25T21:52:56.355386+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:31:07.286224+03:00","closed_at":"2026-02-25T22:31:07.286224+03:00","close_reason":"API + UI каталога, кошелька, eligibility, budget policies реализованы","dependencies":[{"issue_id":"benefit-market-ivk.5","depends_on_id":"benefit-market-ivk","type":"parent-child","created_at":"2026-02-25T21:52:56.355963+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-ivk.6","title":"UI: Страница кошелька с историей транзакций","description":"Страница /dashboard/employee/wallet:\n\n- Крупный блок: текущий баланс, зарезервировано, доступно.\n- Дата сгорания баллов (expires_at).\n- Таблица/список транзакций: дата, тип (accrual/spend/reserve/release/expire), сумма (+/-), описание.\n- Цветовое кодирование: зелёный — начисление, красный — списание, серый — сгорание, жёлтый — резерв.\n- Фильтр по типу транзакции.\n\nКомпоненты: WalletBalance, TransactionList, TransactionRow.\nshadcn/ui: Card, Table, Badge.","status":"closed","priority":2,"issue_type":"task","estimated_minutes":120,"created_at":"2026-02-25T21:52:58.760139+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:31:07.288331+03:00","closed_at":"2026-02-25T22:31:07.288331+03:00","close_reason":"API + UI каталога, кошелька, eligibility, budget policies реализованы","dependencies":[{"issue_id":"benefit-market-ivk.6","depends_on_id":"benefit-market-ivk","type":"parent-child","created_at":"2026-02-25T21:52:58.760881+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-ivk.7","title":"Budget policies: CRUD и применение","description":"Реализовать систему budget policies:\n\n1. Модель: budget_policies с target_filter (JSONB, аналогичен eligibility conditions).\n2. API для HR: просмотр политик своего tenant'а.\n3. Логика применения в lib/budget.ts:\n   - findApplicablePolicy(profile: EmployeeProfile, policies: BudgetPolicy[]): BudgetPolicy | null\n   - Если несколько подходят — берём с наибольшим points_amount (или приоритет).\n\nИспользуется в процессе начисления (accrual).","status":"closed","priority":1,"issue_type":"task","estimated_minutes":90,"created_at":"2026-02-25T21:53:00.683069+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:31:07.291227+03:00","closed_at":"2026-02-25T22:31:07.291227+03:00","close_reason":"API + UI каталога, кошелька, eligibility, budget policies реализованы","dependencies":[{"issue_id":"benefit-market-ivk.7","depends_on_id":"benefit-market-ivk","type":"parent-child","created_at":"2026-02-25T21:53:00.683664+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-ivk.8","title":"API: POST /api/wallets/accrual — начисление баллов","description":"Next.js API route POST /api/wallets/accrual:\n\nДоступ: hr, admin. Запускает начисление для всех сотрудников tenant'а.\n\nАлгоритм:\n1. Получить всех сотрудников tenant'а с employee_profiles.\n2. Получить активные budget_policies tenant'а.\n3. Для каждого сотрудника:\n   a. Найти подходящую policy (по target_filter).\n   b. Проверить: не было ли уже начисления за текущий период.\n   c. Если кошелька нет — создать (period = текущий квартал, expires_at = конец квартала).\n   d. Создать запись point_ledger type=accrual.\n   e. Увеличить wallets.balance.\n4. Всё в транзакции.\n\nResponse: { data: { processed: 50, accrued: 45, skipped: 5, errors: [] } }","status":"closed","priority":1,"issue_type":"task","estimated_minutes":150,"created_at":"2026-02-25T21:53:03.705651+03:00","created_by":"ayugunin","updated_at":"2026-02-25T22:31:07.293349+03:00","closed_at":"2026-02-25T22:31:07.293349+03:00","close_reason":"API + UI каталога, кошелька, eligibility, budget policies реализованы","dependencies":[{"issue_id":"benefit-market-ivk.8","depends_on_id":"benefit-market-ivk","type":"parent-child","created_at":"2026-02-25T21:53:03.706284+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-msy","title":"API + UI: админ-панель управления провайдерами","description":"Админ-функционал для управления провайдерами.\n\nAPI РОУТЫ:\n1. GET /api/admin/providers — список провайдеров\n   - requireRole('admin')\n   - Фильтры: status (pending/verified/suspended/rejected), search\n   - Пагинация\n   - Кол-во предложений и подключений (tenant_offerings count)\n\n2. GET /api/admin/providers/[id] — детали провайдера\n   - Полная инфа + список предложений + статистика\n\n3. PATCH /api/admin/providers/[id] — обновить (в т.ч. статус)\n   - Может менять любые поля включая status\n   - При смене на verified: установить verified_at, verified_by\n   - При смене на rejected: требовать rejection_reason\n   - Аудит-лог\n\n4. POST /api/admin/providers/[id]/verify — shortcut верификации\n   - pending → verified\n   - Установить verified_at = now(), verified_by = admin user id\n\n5. POST /api/admin/providers/[id]/suspend — shortcut блокировки\n   - verified → suspended\n   - Аудит-лог с причиной\n\nUI СТРАНИЦА:\n- src/app/dashboard/admin/providers/page.tsx\n  - Таблица провайдеров (имя, slug, статус, дата регистрации, кол-во предложений)\n  - Фильтр по статусу (вкладки)\n  - Поиск по имени\n  - Действия: Verify / Suspend / View details\n  - Модальное окно деталей с полной информацией\n\nФайлы:\n- src/app/api/admin/providers/route.ts (GET)\n- src/app/api/admin/providers/[id]/route.ts (GET, PATCH)\n- src/app/api/admin/providers/[id]/verify/route.ts (POST)\n- src/app/api/admin/providers/[id]/suspend/route.ts (POST)\n- src/app/dashboard/admin/providers/page.tsx","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T08:58:28.892258+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:19:00.099296+03:00","closed_at":"2026-02-27T09:19:00.099296+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-msy","depends_on_id":"benefit-market-cm7","type":"blocks","created_at":"2026-02-27T09:00:37.775005+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-msy","depends_on_id":"benefit-market-dlq","type":"blocks","created_at":"2026-02-27T09:00:38.002108+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-mxo","title":"Zod-валидаторы для маркетплейса","description":"Добавить Zod-схемы валидации в src/lib/api/validators.ts:\n\n1. registerProviderSchema: name (1-255), slug (1-100, regex /^[a-z0-9-]+$/), description, logo_url (url), website (url), contact_email (email), contact_phone, address\n2. updateProviderSchema: все поля optional\n3. createProviderOfferingSchema: global_category_id (uuid), name (1-255), description, long_description, image_urls (array of url), base_price_points (int, min 1), stock_limit (int, min 0, nullable), delivery_info, terms_conditions\n4. updateProviderOfferingSchema: все поля optional\n5. enableTenantOfferingSchema: provider_offering_id (uuid), custom_price_points (int, min 1, nullable), tenant_stock_limit (int, min 0, nullable), tenant_category_id (uuid, nullable)\n6. updateTenantOfferingSchema: custom_price_points, tenant_stock_limit, is_active, tenant_category_id — все optional\n7. createReviewSchema: provider_offering_id (uuid), rating (int, 1-5), title (max 200), body (max 5000)\n8. updateReviewSchema: rating, title, body — optional\n\nСледовать паттернам из существующих createBenefitSchema, createCategorySchema.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T08:57:30.548365+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:15:31.758139+03:00","closed_at":"2026-02-27T09:15:31.758139+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-mxo","depends_on_id":"benefit-market-6b1","type":"blocks","created_at":"2026-02-27T08:57:58.50368+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-of5","title":"3.1 Allow HR role in policies API GET","description":"## 3.1 Allow HR role in policies API GET\n\n### Файл\n`src/app/api/admin/policies/route.ts` (line 62)\n\n### Текущее состояние\n```typescript\nif (appUser.role !== 'admin') {\n  return NextResponse.json({ error: ... }, { status: 403 });\n}\n```\nHR пользователи получают 403 Forbidden при попытке просмотреть политики.\n\n### Что сделать\nИзменить проверку роли ТОЛЬКО для GET handler:\n```typescript\nif (appUser.role !== 'admin' \u0026\u0026 appUser.role !== 'hr') {\n  return NextResponse.json({ error: ... }, { status: 403 });\n}\n```\nPOST handler оставить только для admin.\n\n### Верификация\n- HR может GET /api/admin/policies → 200\n- HR не может POST /api/admin/policies → 403\n- Admin может GET и POST как прежде\n- Employee получает 403 на GET","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-25T23:54:22.655213+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:03:52.904315+03:00","closed_at":"2026-02-26T00:03:52.904315+03:00","close_reason":"Closed"}
{"id":"benefit-market-onf","title":"API: заказы и аналитика провайдера","description":"API для просмотра заказов и аналитики провайдера.\n\nРОУТЫ:\n1. GET /api/provider/orders — заказы содержащие предложения этого провайдера\n   - requireRole('provider')\n   - Запрос через order_items.provider_offering_id → orders\n   - Фильтры: status (paid/reserved/cancelled), date range\n   - Пагинация\n   - Для каждого заказа: offering name, tenant name (анонимизированное), quantity, points, status, date\n   - Использовать admin client для кросс-тенантного запроса\n\n2. GET /api/provider/analytics — дашборд провайдера\n   - Метрики:\n     - Общее кол-во заказов (total, за месяц, за неделю)\n     - Общее кол-во баллов (заработано)\n     - Средний рейтинг по всем предложениям\n     - Кол-во компаний подключивших предложения (count distinct tenant_id из tenant_offerings)\n     - Кол-во активных предложений\n     - Популярные предложения (top 5 по заказам)\n     - Тренд заказов за последние 6 месяцев\n   - Использовать admin client\n\nФайлы:\n- src/app/api/provider/orders/route.ts\n- src/app/api/provider/analytics/route.ts","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-27T08:58:17.005513+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:17:40.716258+03:00","closed_at":"2026-02-27T09:17:40.716258+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-onf","depends_on_id":"benefit-market-itu","type":"blocks","created_at":"2026-02-27T09:00:37.548558+03:00","created_by":"ayugunin"},{"issue_id":"benefit-market-onf","depends_on_id":"benefit-market-79o","type":"blocks","created_at":"2026-02-27T09:00:42.976096+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-r84","title":"Demo-данные маркетплейса","description":"Обновить demo-data.ts и demo-service.ts для поддержки маркетплейса.\n\nDEMO ПРОВАЙДЕРЫ (4 шт):\n1. World Class (фитнес) — verified, slug: world-class\n2. Skillbox (образование) — verified, slug: skillbox\n3. Медси (здоровье) — verified, slug: medsi\n4. Яндекс Лавка (питание) — pending (для демонстрации модерации)\n\nDEMO ПРЕДЛОЖЕНИЯ (8-10 шт):\n- World Class: Годовой абонемент (24000 pts), Бассейн (12000 pts)\n- Skillbox: Курс Python (15000 pts), Курс дизайна (12000 pts)\n- Медси: ДМС расширенный (30000 pts), Стоматология (15000 pts), Психолог онлайн (5000 pts)\n- Яндекс Лавка: Подписка на доставку (6000 pts)\n- Статусы: большинство published, 1-2 в draft\n\nDEMO TENANT_OFFERINGS:\n- Для demo-тенанта подключить 6 из 8 предложений\n- Один с кастомной ценой (World Class со скидкой)\n\nDEMO REVIEWS (5-6 шт):\n- Разные рейтинги (3-5 звёзд)\n- С текстом отзывов\n- Агрегаты: avg_rating и review_count заполнены\n\nDEMO GLOBAL CATEGORIES:\n- Здоровье, Спорт, Образование, Питание, Транспорт, Развлечения\n\nОбновить demo-service.ts:\n- demoBenefitsList(): объединять legacy benefits + marketplace offerings\n- demoOfferingsList(): marketplace-only\n- demoOfferingDetail(): с рейтингами и отзывами\n- demoProvidersList(): для админки\n- demoHRMarketplace(): для HR-маркетплейса","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-27T09:00:22.154196+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:30:53.744856+03:00","closed_at":"2026-02-27T09:30:53.744856+03:00","close_reason":"Demo data added: 8 global categories, 4 providers, 8 offerings, 6 tenant offerings, 6 reviews","dependencies":[{"issue_id":"benefit-market-r84","depends_on_id":"benefit-market-6b1","type":"blocks","created_at":"2026-02-27T09:00:44.191153+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-rbk","title":"3.2 Implement HR policies page","description":"## 3.2 Implement HR policies page\n\n### Файл\n`src/app/dashboard/hr/policies/page.tsx` (сейчас 7 строк — стаб)\n\n### Текущее состояние\n```tsx\nexport default function HrPoliciesPage() {\n  return (\n    \u003cdiv className='page-transition p-6'\u003e\n      \u003ch1 className='text-2xl font-heading font-bold'\u003eБюджетные политики\u003c/h1\u003e\n    \u003c/div\u003e\n  );\n}\n```\n\n### Что сделать\nRead-only таблица по паттерну admin/policies (файл admin/policies/page.tsx):\n1. 'use client' + fetch /api/admin/policies\n2. Таблица: Название, Баллов, Период, Фильтр группы, Статус (Badge active/inactive)\n3. DataTablePagination\n4. Loading state (Loader2 spinner)\n5. Empty state\n6. **НЕ** добавлять кнопки создания/редактирования/переключения — только просмотр\n\n### Паттерн (из admin/policies/page.tsx)\nИспользовать те же компоненты: Table, TableBody, TableCell, TableHead, TableHeader, TableRow, Badge, DataTablePagination, Loader2.\nИспользовать PERIOD_LABELS маппинг: monthly→Ежемесячно, quarterly→Ежеквартально, yearly→Ежегодно.\nИспользовать formatFilter для отображения target_filter.\n\n### Верификация\n- HR видит список политик в табличном виде\n- Пагинация работает (\u003e20 записей)\n- Loading spinner при загрузке\n- Сообщение при пустом списке\n- Нет кнопок редактирования","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-25T23:54:24.302159+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:03:52.975697+03:00","closed_at":"2026-02-26T00:03:52.975697+03:00","close_reason":"Closed"}
{"id":"benefit-market-svr","title":"Seed глобальных категорий и платформенного тенанта","description":"Создать seed-данные:\n\n1. Платформенный тенант (id=00000000-0000-0000-0000-000000000000) — уже в миграции, но убедиться в seed.sql\n\n2. Глобальные категории (global_categories) — перенести из существующих benefit_categories:\n- Здоровье (heart-pulse)\n- Образование (graduation-cap)\n- Спорт (dumbbell)\n- Питание (utensils)\n- Транспорт (car)\n- Развлечения (sparkles)\n- Финансы (wallet)\n- Красота (heart)\n\n3. Маппинг: обновить существующие benefit_categories.global_category_id\n\n4. Обновить demo-data.ts — добавить глобальные категории в демо-набор","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-27T08:57:50.18847+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:15:31.825902+03:00","closed_at":"2026-02-27T09:15:31.825902+03:00","close_reason":"Closed","dependencies":[{"issue_id":"benefit-market-svr","depends_on_id":"benefit-market-dlq","type":"blocks","created_at":"2026-02-27T08:58:10.926932+03:00","created_by":"ayugunin"}]}
{"id":"benefit-market-t2x","title":"1.2 Connect add-to-cart on detail page","description":"## 1.2 Connect add-to-cart on detail page\n\n### Файл\n`src/app/dashboard/employee/catalog/[id]/page.tsx` (lines 231-235)\n\n### Текущее состояние\nКнопка `\u003cButton disabled={!canAfford \u0026\u0026 balance !== null}\u003eДобавить в корзину\u003c/Button\u003e` — нет onClick handler.\n\n### Что сделать\n1. Импортировать `useCartStore` из `@/lib/store/cart`\n2. Импортировать `toast` из `sonner`\n3. Получить `addItem` из стора\n4. Добавить onClick:\n   - `addItem({ id, name, price_points, category_name, category_icon })`\n   - `toast.success(...)`\n\n### Верификация\n- Клик на кнопку на детальной странице → товар в корзине\n- Кнопка disabled если баланс недостаточен","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-25T23:54:14.57716+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:02:20.851871+03:00","closed_at":"2026-02-26T00:02:20.851871+03:00","close_reason":"Closed"}
{"id":"benefit-market-v3n","title":"EPIC: AI-чатбот / виртуальный HR-ассистент","description":"24/7 ассистент: какую льготу выбрать, сколько баллов, что покрывает ДМС. Ключевой вопрос: как бот получает инфу о конкретной компании. Варианты: RAG по документам компании, structured data из настроек тенанта, FAQ от HR. Автоматизация до 75% HR-запросов по льготам.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-27T08:36:45.950604+03:00","created_by":"ayugunin","updated_at":"2026-02-27T08:36:45.950604+03:00"}
{"id":"benefit-market-vwk","title":"Peer Recognition: backend и API","description":"Бэкенд системы благодарностей между коллегами.\n\nНОВЫЕ ТАБЛИЦЫ:\n1. recognition_budgets:\n   - id, tenant_id, user_id (FK, UNIQUE per tenant+user)\n   - monthly_budget (int) — сколько баллов в месяц может раздать\n   - remaining_budget (int) — сколько осталось в текущем месяце\n   - resets_at (timestamptz) — когда сбрасывается (1е число месяца)\n\n2. recognitions:\n   - id, tenant_id\n   - from_user_id (FK→users) — кто благодарит\n   - to_user_id (FK→users) — кого благодарят\n   - points (int, CHECK \u003e 0) — сколько баллов передаёт\n   - message (text, NOT NULL, min 10 chars) — текст благодарности\n   - category: 'teamwork' | 'innovation' | 'mentoring' | 'going_above' | 'other'\n   - is_public (boolean, default true) — видна ли на стене\n   - created_at\n   - CHECK: from_user_id \\!= to_user_id\n\nRLS:\n- recognition_budgets: пользователь видит свой, HR/admin видит все в тенанте\n- recognitions: все в тенанте видят public, от/кому видит private\n\nAPI:\n1. POST /api/recognitions — отправить благодарность\n   - requireAuth()\n   - Проверки: достаточно remaining_budget, нельзя себе\n   - Списать из recognition_budgets.remaining_budget\n   - Начислить to_user в кошелёк (через admin client)\n   - Записать в point_ledger: type='recognition_received'\n\n2. GET /api/recognitions — стена благодарностей (public, tenant-scoped)\n   - Пагинация, фильтр по категории\n   - Последние 50\n\n3. GET /api/recognitions/my — мои полученные/отправленные\n4. GET /api/recognitions/budget — мой бюджет на признание\n\n5. GET /api/hr/recognitions/stats — статистика для HR\n   - Самые благодарные сотрудники\n   - Самые ценные коллеги (по полученным)\n   - Распределение по категориям\n\nCRON/SCHEDULED: Ежемесячный сброс remaining_budget → monthly_budget\n- Реализация: Supabase pg_cron или API endpoint /api/cron/reset-recognition-budgets\n\nНАСТРОЙКА (HR/admin):\n- GET/PUT /api/hr/recognition-settings\n  - monthly_budget_per_employee (default 500)\n  - min_points_per_recognition (default 50)\n  - max_points_per_recognition (default 200)\n  - categories (customizable)\n\nФайлы:\n- supabase/migrations/00010_peer_recognition.sql\n- src/app/api/recognitions/route.ts\n- src/app/api/recognitions/my/route.ts\n- src/app/api/recognitions/budget/route.ts\n- src/app/api/hr/recognitions/stats/route.ts\n- src/app/api/hr/recognition-settings/route.ts\n- src/lib/services/recognition.service.ts","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-27T09:16:51.749855+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:16:51.749855+03:00"}
{"id":"benefit-market-xy6","title":"Epic 4: Admin Categories Page","description":"## Epic 4: Admin Categories Page\n\n### Контекст\nАдминистратор не может управлять категориями льгот через UI. API /api/admin/categories имеет только GET и POST, нет PATCH/DELETE. Нет страницы управления категориями в дашборде и нет пункта в сайдбаре.\n\n### Задачи\n- 4.1 Add PATCH/DELETE to categories API (benefit-market-8wa)\n- 4.2 Create admin categories page (benefit-market-0cf)\n- 4.3 Add Categories to admin sidebar (benefit-market-4op)\n\n### Верификация\n- Пункт 'Категории' в admin sidebar\n- CRUD работает: создание, редактирование, удаление категорий\n- Паттерн UI совпадает с admin/benefits","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-25T23:54:25.827378+03:00","created_by":"ayugunin","updated_at":"2026-02-26T00:06:31.62512+03:00","closed_at":"2026-02-26T00:06:31.62512+03:00","close_reason":"Closed"}
{"id":"benefit-market-yqh","title":"AI-чатбот: UI виджет","description":"Фронтенд чатбота — плавающий виджет для сотрудников.\n\nКОМПОНЕНТЫ:\n1. src/components/chat/chat-widget.tsx\n   - Плавающая кнопка в правом нижнем углу (MessageCircle icon)\n   - При клике: раскрывается окно чата (400x500px)\n   - Анимация появления (slide up + fade in)\n\n2. src/components/chat/chat-window.tsx\n   - Заголовок: 'HR-ассистент' + кнопка закрыть\n   - Список сообщений (scroll)\n   - Поле ввода + кнопка отправить (Enter)\n   - Streaming response: текст появляется по мере генерации\n   - Typing indicator при ожидании\n   - Quick actions: 'Мой баланс', 'Популярные льготы', 'FAQ'\n\n3. src/components/chat/chat-message.tsx\n   - Сообщение пользователя (справа, accent цвет)\n   - Ответ бота (слева, с аватаром бота)\n   - Markdown rendering для ответов бота\n\n4. src/components/chat/chat-history.tsx\n   - Список прошлых диалогов\n   - Клик → загрузить историю\n\nИНТЕГРАЦИЯ:\n- Показывать виджет на всех /dashboard/employee/* страницах\n- src/app/dashboard/employee/layout.tsx — добавить \u003cChatWidget /\u003e\n- Feature flag: ENABLE_CHATBOT\n\nSTATE:\n- Zustand store: src/lib/store/chat.ts\n  - messages, conversationId, isOpen, isLoading\n  - sendMessage(), loadHistory(), toggleOpen()\n\nФайлы:\n- src/components/chat/chat-widget.tsx\n- src/components/chat/chat-window.tsx\n- src/components/chat/chat-message.tsx\n- src/components/chat/chat-history.tsx\n- src/lib/store/chat.ts\n- src/app/dashboard/employee/layout.tsx (обновить)","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-27T09:16:30.772054+03:00","created_by":"ayugunin","updated_at":"2026-02-27T09:16:30.772054+03:00","dependencies":[{"issue_id":"benefit-market-yqh","depends_on_id":"benefit-market-dpv","type":"blocks","created_at":"2026-02-27T09:17:08.600423+03:00","created_by":"ayugunin"}]}
