# Ответы на вопросы по кабинету HR

## 1. «Тренд начислений и расходов» — что это и методология

### Что показывает график

График «Тренд начислений и расходов» — это **Area Chart**, отображающий динамику за последние 6 месяцев по двум метрикам:

- **Начислено (Accrued)** — синяя область — сколько баллов было зачислено сотрудникам за месяц
- **Потрачено (Spent)** — оранжевая область — сколько баллов сотрудники использовали (подтвердили заказы) за месяц

### Методология расчёта

1. **Источник данных:** таблица `point_ledger` — это неизменяемый журнал всех операций с баллами

2. **Начисления (accrued):**
   - Суммируются все записи с `type = "accrual"` за каждый месяц
   - Начисления происходят согласно бюджетным политикам (`budget_policies`)
   - Каждому сотруднику подбирается наиболее подходящая политика на основе его профиля (грейд, локация, юрлицо)
   - Если подходят несколько политик — выбирается с наибольшей суммой баллов
   - Периодичность начислений зависит от политики: ежемесячно, ежеквартально или ежегодно

3. **Расходы (spent):**
   - Суммируются все записи с `type = "spend"` за каждый месяц
   - Расход фиксируется в момент **подтверждения заказа** (не в момент резервирования)
   - То есть «потрачено» — это реально использованные баллы, а не зарезервированные

4. **Группировка:**
   - Данные группируются по месяцу (первые 7 символов даты `created_at`, формат YYYY-MM)
   - Показываются последние 6 месяцев
   - Месяцы отображаются на русском ("Янв 26", "Фев 26" и т.д.)

### Что это НЕ показывает

- **Не показывает** резервирования (type="reserve") и отмены (type="release")
- **Не показывает** истёкшие резервации (type="expire")
- **Не показывает** количество транзакций — только суммы баллов

### Как интерпретировать

| Паттерн | Что означает |
|---------|-------------|
| Начислено >> Потрачено | Сотрудники не используют бюджет, низкая утилизация |
| Начислено ≈ Потрачено | Здоровое использование, бюджет расходуется |
| Потрачено > Начислено | Сотрудники тратят накопленные ранее баллы |
| Начислено растёт | Увеличение бюджета или рост штата |
| Потрачено растёт | Рост вовлечённости сотрудников |

---

## 2. «Баланс баллов» — что это?

### Определение

**Баланс баллов** — это текущее количество баллов, доступных сотруднику для использования. Отображается в колонке «Баланс баллов» таблицы сотрудников в HR-кабинете.

### Как рассчитывается

Баланс хранится в таблице `wallets` и состоит из двух компонентов:

```
Баланс (balance) = Все начисления − Все подтверждённые расходы
Доступно (available) = Баланс − Зарезервировано
```

Где:
- **Баланс (balance):** Полная сумма, которой сотрудник «владеет». Уменьшается только при подтверждении заказа
- **Зарезервировано (reserved):** Баллы, заблокированные под активные (ещё не подтверждённые) заказы
- **Доступно (available):** Баллы, которые сотрудник реально может потратить прямо сейчас

### Жизненный цикл баллов

```
Начисление (accrual)     → balance += N
Заказ оформлен (reserve) → reserved += N
Заказ подтверждён (spend) → balance -= N, reserved -= N
Заказ отменён (release)  → reserved -= N
Резерв истёк (expire)    → reserved -= N
```

### Что видит HR

В таблице сотрудников HR видит поле **balance** из последнего кошелька сотрудника — то есть общий баланс (до вычета резервов). Это показывает, сколько баллов у сотрудника **в целом**, включая те, что могут быть временно зарезервированы.

### Периоды кошелька

Кошельки привязаны к периодам (например, "2026-Q1" или "2026-M01"). В таблице HR отображается баланс **последнего по дате** кошелька. Каждый кошелёк имеет дату истечения (`expires_at`), после которой неиспользованные баллы могут сгореть.

### Пример

| Событие | balance | reserved | Доступно |
|---------|---------|----------|----------|
| Начисление 5000 баллов | 5000 | 0 | 5000 |
| Заказ на 2000 (резерв) | 5000 | 2000 | 3000 |
| Заказ подтверждён | 3000 | 0 | 3000 |
| Ещё заказ на 1000 (резерв) | 3000 | 1000 | 2000 |
| Заказ отменён | 3000 | 0 | 3000 |
