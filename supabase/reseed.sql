-- Delete old seed data (cascade through FKs)
DELETE FROM point_ledger WHERE tenant_id = '00000000-0000-0000-0000-000000000001';
DELETE FROM order_items WHERE order_id IN (SELECT id FROM orders WHERE tenant_id = '00000000-0000-0000-0000-000000000001');
DELETE FROM orders WHERE tenant_id = '00000000-0000-0000-0000-000000000001';
DELETE FROM audit_log WHERE tenant_id = '00000000-0000-0000-0000-000000000001';
DELETE FROM wallets WHERE tenant_id = '00000000-0000-0000-0000-000000000001';
DELETE FROM eligibility_rules WHERE tenant_id = '00000000-0000-0000-0000-000000000001';
DELETE FROM budget_policies WHERE tenant_id = '00000000-0000-0000-0000-000000000001';
DELETE FROM benefits WHERE tenant_id = '00000000-0000-0000-0000-000000000001';
DELETE FROM benefit_categories WHERE tenant_id = '00000000-0000-0000-0000-000000000001';
DELETE FROM employee_profiles WHERE tenant_id = '00000000-0000-0000-0000-000000000001';
DELETE FROM users WHERE tenant_id = '00000000-0000-0000-0000-000000000001' AND auth_id NOT IN (SELECT id FROM auth.users);
DELETE FROM tenants WHERE id = '00000000-0000-0000-0000-000000000001';

-- =============================================================
-- Benefit Market — Seed Data
-- =============================================================
-- Реалистичные тестовые данные для демонстрации.
-- Все INSERT используют ON CONFLICT DO NOTHING для идемпотентности.
-- =============================================================

-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-- Фиксированные UUID-константы
-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

-- Тенант
-- tenant:  00000000-0000-4000-8000-000000000001

-- Пользователи (3 ключевых + 5 сотрудников)
-- admin:      00000000-0000-4000-8000-000000000010
-- hr:         00000000-0000-4000-8000-000000000020
-- employee:   00000000-0000-4000-8000-000000000030
-- emp_junior: 00000000-0000-4000-8000-000000000031
-- emp_middle: 00000000-0000-4000-8000-000000000032
-- emp_senior: 00000000-0000-4000-8000-000000000033
-- emp_lead:   00000000-0000-4000-8000-000000000034
-- emp_dir:    00000000-0000-4000-8000-000000000035

-- Категории
-- cat_health:    00000000-0000-4000-8000-000000000100
-- cat_sport:     00000000-0000-4000-8000-000000000101
-- cat_education: 00000000-0000-4000-8000-000000000102
-- cat_food:      00000000-0000-4000-8000-000000000103
-- cat_leisure:   00000000-0000-4000-8000-000000000104

-- Бенефиты (15 шт.)
-- ben_dms:         00000000-0000-4000-8000-000000000200
-- ben_dental:      00000000-0000-4000-8000-000000000201
-- ben_vitamins:    00000000-0000-4000-8000-000000000202
-- ben_fitness:     00000000-0000-4000-8000-000000000203
-- ben_pool:        00000000-0000-4000-8000-000000000204
-- ben_sport_club:  00000000-0000-4000-8000-000000000205
-- ben_english:     00000000-0000-4000-8000-000000000206
-- ben_online:      00000000-0000-4000-8000-000000000207
-- ben_conference:  00000000-0000-4000-8000-000000000208
-- ben_lunch:       00000000-0000-4000-8000-000000000209
-- ben_delivery:    00000000-0000-4000-8000-00000000020a
-- ben_coffee:      00000000-0000-4000-8000-00000000020b
-- ben_sanatorium:  00000000-0000-4000-8000-00000000020c
-- ben_excursion:   00000000-0000-4000-8000-00000000020d
-- ben_culture:     00000000-0000-4000-8000-00000000020e

-- Кошельки
-- wallet_admin:      00000000-0000-4000-8000-000000000300
-- wallet_hr:         00000000-0000-4000-8000-000000000301
-- wallet_employee:   00000000-0000-4000-8000-000000000302
-- wallet_junior:     00000000-0000-4000-8000-000000000303
-- wallet_middle:     00000000-0000-4000-8000-000000000304
-- wallet_senior:     00000000-0000-4000-8000-000000000305
-- wallet_lead:       00000000-0000-4000-8000-000000000306
-- wallet_director:   00000000-0000-4000-8000-000000000307

-- Заказы
-- order_fitness:  00000000-0000-4000-8000-000000000400
-- order_english:  00000000-0000-4000-8000-000000000401
-- order_vitamins: 00000000-0000-4000-8000-000000000402


-- =============================================================
-- 1. Тенант
-- =============================================================

INSERT INTO tenants (id, name, domain, settings)
VALUES (
    '00000000-0000-4000-8000-000000000001',
    'ООО Технологии Будущего',
    'techfuture.ru',
    '{
        "locale": "ru",
        "currency_label": "баллы",
        "fiscal_year_start": "01-01",
        "branding": {
            "primary_color": "#2563EB",
            "logo_url": "/assets/logo-techfuture.svg"
        }
    }'::jsonb
)
ON CONFLICT DO NOTHING;


-- =============================================================
-- 2. Пользователи — 3 ключевых
-- =============================================================

INSERT INTO users (id, tenant_id, auth_id, email, role) VALUES
    ('00000000-0000-4000-8000-000000000010', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000010', 'admin@techfuture.ru',  'admin'),
    ('00000000-0000-4000-8000-000000000020', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000020', 'hr@techfuture.ru',     'hr'),
    ('00000000-0000-4000-8000-000000000030', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000030', 'ivan@techfuture.ru',   'employee')
ON CONFLICT DO NOTHING;


-- =============================================================
-- 3. Пользователи — 5 дополнительных сотрудников
-- =============================================================

INSERT INTO users (id, tenant_id, auth_id, email, role) VALUES
    ('00000000-0000-4000-8000-000000000031', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000031', 'anna.petrova@techfuture.ru',     'employee'),
    ('00000000-0000-4000-8000-000000000032', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000032', 'dmitry.sokolov@techfuture.ru',   'employee'),
    ('00000000-0000-4000-8000-000000000033', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000033', 'elena.kuznetsova@techfuture.ru', 'employee'),
    ('00000000-0000-4000-8000-000000000034', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000034', 'sergey.volkov@techfuture.ru',    'employee'),
    ('00000000-0000-4000-8000-000000000035', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000035', 'maria.novikova@techfuture.ru',   'employee')
ON CONFLICT DO NOTHING;


-- =============================================================
-- 4. Профили сотрудников (для всех 8 пользователей)
-- =============================================================

INSERT INTO employee_profiles (id, user_id, tenant_id, grade, tenure_months, location, legal_entity, extra) VALUES
    -- admin — директор, 60 мес. стажа
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000010', '00000000-0000-4000-8000-000000000001',
     'director', 60, 'Москва', 'ООО ТБ',
     '{"full_name": "Алексей Михайлович Сидоров", "department": "Управление", "position": "Генеральный директор"}'::jsonb),

    -- hr — senior, 36 мес. стажа
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000020', '00000000-0000-4000-8000-000000000001',
     'senior', 36, 'Москва', 'ООО ТБ',
     '{"full_name": "Ольга Сергеевна Белова", "department": "HR", "position": "Руководитель HR-отдела"}'::jsonb),

    -- ivan — middle, 18 мес. стажа (основной тестовый сотрудник)
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000030', '00000000-0000-4000-8000-000000000001',
     'middle', 18, 'Москва', 'ООО ТБ',
     '{"full_name": "Иван Андреевич Козлов", "department": "Разработка", "position": "Разработчик"}'::jsonb),

    -- anna — junior, 4 мес. стажа
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000031', '00000000-0000-4000-8000-000000000001',
     'junior', 4, 'Санкт-Петербург', 'ООО ТБ Северо-Запад',
     '{"full_name": "Анна Игоревна Петрова", "department": "Дизайн", "position": "Младший дизайнер"}'::jsonb),

    -- dmitry — middle, 24 мес. стажа
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000032', '00000000-0000-4000-8000-000000000001',
     'middle', 24, 'Казань', 'ООО ТБ',
     '{"full_name": "Дмитрий Олегович Соколов", "department": "Аналитика", "position": "Аналитик данных"}'::jsonb),

    -- elena — senior, 30 мес. стажа
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000033', '00000000-0000-4000-8000-000000000001',
     'senior', 30, 'Москва', 'ООО ТБ',
     '{"full_name": "Елена Викторовна Кузнецова", "department": "Разработка", "position": "Старший разработчик"}'::jsonb),

    -- sergey — lead, 42 мес. стажа
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000034', '00000000-0000-4000-8000-000000000001',
     'lead', 42, 'Санкт-Петербург', 'ООО ТБ Северо-Запад',
     '{"full_name": "Сергей Александрович Волков", "department": "Разработка", "position": "Тимлид бэкенд-команды"}'::jsonb),

    -- maria — director, 48 мес. стажа
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000035', '00000000-0000-4000-8000-000000000001',
     'director', 48, 'Москва', 'ООО ТБ',
     '{"full_name": "Мария Дмитриевна Новикова", "department": "Продукт", "position": "Директор по продукту"}'::jsonb)
ON CONFLICT DO NOTHING;


-- =============================================================
-- 5. Категории бенефитов
-- =============================================================

INSERT INTO benefit_categories (id, tenant_id, name, icon, sort_order) VALUES
    ('00000000-0000-4000-8000-000000000100', '00000000-0000-4000-8000-000000000001', 'Здоровье',  'heart-pulse',    1),
    ('00000000-0000-4000-8000-000000000101', '00000000-0000-4000-8000-000000000001', 'Спорт',     'dumbbell',       2),
    ('00000000-0000-4000-8000-000000000102', '00000000-0000-4000-8000-000000000001', 'Обучение',  'graduation-cap', 3),
    ('00000000-0000-4000-8000-000000000103', '00000000-0000-4000-8000-000000000001', 'Питание',   'utensils',       4),
    ('00000000-0000-4000-8000-000000000104', '00000000-0000-4000-8000-000000000001', 'Отдых',     'palmtree',       5)
ON CONFLICT DO NOTHING;


-- =============================================================
-- 6. Бенефиты (15 штук)
-- =============================================================

INSERT INTO benefits (id, tenant_id, category_id, name, description, price_points, stock_limit, is_active) VALUES
    -- Здоровье (3)
    ('00000000-0000-4000-8000-000000000200', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000100',
     'ДМС расширенное',
     'Полис добровольного медицинского страхования с расширенным покрытием: стационар, амбулатория, вызов врача на дом, телемедицина. Сеть клиник «Медси», «Чайка», GMS Clinic.',
     30000, NULL, true),

    ('00000000-0000-4000-8000-000000000201', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000100',
     'Стоматология',
     'Годовая стоматологическая программа: профилактика, лечение, гигиена полости рта. Клиника «Белая Радуга».',
     15000, NULL, true),

    ('00000000-0000-4000-8000-000000000202', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000100',
     'Витамины и БАД',
     'Ежеквартальный набор витаминов и биологически активных добавок от iHerb. Персональный подбор по результатам чекапа.',
     3000, 100, true),

    -- Спорт (3)
    ('00000000-0000-4000-8000-000000000203', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000101',
     'Фитнес-клуб годовой',
     'Годовой абонемент в сеть фитнес-клубов World Class или DDX Fitness. Включает тренажёрный зал, групповые программы, сауну.',
     24000, NULL, true),

    ('00000000-0000-4000-8000-000000000204', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000101',
     'Бассейн квартальный',
     'Абонемент в бассейн на 3 месяца (12 посещений). «Олимпийский» или «Чайка».',
     8000, 50, true),

    ('00000000-0000-4000-8000-000000000205', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000101',
     'Спортивная секция',
     'Оплата занятий в спортивной секции на выбор: теннис, единоборства, волейбол, йога. Квартальный абонемент.',
     12000, NULL, true),

    -- Обучение (3)
    ('00000000-0000-4000-8000-000000000206', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000102',
     'Курсы английского',
     'Индивидуальные или групповые занятия английским языком с носителем. 2 раза в неделю, 3 месяца. Школа Skyeng / EnglishFirst.',
     18000, NULL, true),

    ('00000000-0000-4000-8000-000000000207', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000102',
     'Онлайн-курсы',
     'Подписка на образовательные платформы: Coursera, Udemy, Stepik. Один курс на выбор.',
     6000, NULL, true),

    ('00000000-0000-4000-8000-000000000208', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000102',
     'Конференция',
     'Оплата участия в профессиональной конференции: HighLoad++, TeamLead Conf, PyCon Russia, Стачка и др. Включает билет и дорогу.',
     25000, 30, true),

    -- Питание (3)
    ('00000000-0000-4000-8000-000000000209', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000103',
     'Обеды в офисе',
     'Компенсация обедов в офисной столовой. Квартальный лимит: 60 обедов по 150 руб.',
     9000, NULL, true),

    ('00000000-0000-4000-8000-00000000020a', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000103',
     'Доставка еды',
     'Баланс на сервисе доставки еды (Яндекс.Еда / Delivery Club) для удалённых сотрудников.',
     12000, NULL, true),

    ('00000000-0000-4000-8000-00000000020b', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000103',
     'Кофемашина',
     'Безлимитный доступ к премиальному кофе в офисе: капучино, латте, флэт-уайт. Зёрна Tasty Coffee.',
     5000, NULL, true),

    -- Отдых (3)
    ('00000000-0000-4000-8000-00000000020c', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000104',
     'Путёвка в санаторий',
     'Путёвка на 14 дней в санаторий «Барвиха» или «Подмосковье». Проживание, питание, лечебные процедуры.',
     40000, 10, true),

    ('00000000-0000-4000-8000-00000000020d', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000104',
     'Экскурсия выходного дня',
     'Организованная экскурсия на выходные: Суздаль, Коломна, Тула, Нижний Новгород. Транспорт + гид + обед.',
     8000, 50, true),

    ('00000000-0000-4000-8000-00000000020e', '00000000-0000-4000-8000-000000000001', '00000000-0000-4000-8000-000000000104',
     'Культурные мероприятия',
     'Билеты на театр, концерт или выставку. Два билета на одно мероприятие по выбору сотрудника.',
     5000, NULL, true)
ON CONFLICT DO NOTHING;


-- =============================================================
-- 7. Правила доступности (eligibility_rules)
-- =============================================================

INSERT INTO eligibility_rules (id, benefit_id, tenant_id, conditions) VALUES
    -- ДМС расширенное — только senior, lead, director
    (gen_random_uuid(),
     '00000000-0000-4000-8000-000000000200',
     '00000000-0000-4000-8000-000000000001',
     '{
         "rule_name": "ДМС расширенное — грейд senior+",
         "match_all": [
             { "field": "grade", "operator": "in", "value": ["senior", "lead", "director"] }
         ]
     }'::jsonb),

    -- Путёвка в санаторий — стаж >= 12 мес.
    (gen_random_uuid(),
     '00000000-0000-4000-8000-00000000020c',
     '00000000-0000-4000-8000-000000000001',
     '{
         "rule_name": "Путёвка в санаторий — стаж от 12 месяцев",
         "match_all": [
             { "field": "tenure_months", "operator": "gte", "value": 12 }
         ]
     }'::jsonb),

    -- Конференция — middle, senior, lead, director
    (gen_random_uuid(),
     '00000000-0000-4000-8000-000000000208',
     '00000000-0000-4000-8000-000000000001',
     '{
         "rule_name": "Конференция — грейд middle+",
         "match_all": [
             { "field": "grade", "operator": "in", "value": ["middle", "senior", "lead", "director"] }
         ]
     }'::jsonb)
ON CONFLICT DO NOTHING;


-- =============================================================
-- 8. Бюджетные политики
-- =============================================================

INSERT INTO budget_policies (id, tenant_id, name, points_amount, period, target_filter, is_active) VALUES
    -- Стандартная — 50 000 баллов/квартал, все сотрудники
    ('00000000-0000-4000-8000-000000000500',
     '00000000-0000-4000-8000-000000000001',
     'Стандартная',
     50000,
     'quarterly',
     '{
         "description": "Все сотрудники компании",
         "match_all": []
     }'::jsonb,
     true),

    -- Руководительская — 80 000 баллов/квартал, lead + director
    ('00000000-0000-4000-8000-000000000501',
     '00000000-0000-4000-8000-000000000001',
     'Руководительская',
     80000,
     'quarterly',
     '{
         "description": "Руководители (lead и director)",
         "match_all": [
             { "field": "grade", "operator": "in", "value": ["lead", "director"] }
         ]
     }'::jsonb,
     true)
ON CONFLICT DO NOTHING;


-- =============================================================
-- 9. Кошельки — период 2025-Q1
-- =============================================================

INSERT INTO wallets (id, user_id, tenant_id, balance, reserved, period, expires_at) VALUES
    -- admin (director) — 80 000
    ('00000000-0000-4000-8000-000000000300',
     '00000000-0000-4000-8000-000000000010', '00000000-0000-4000-8000-000000000001',
     80000, 0, '2025-Q1', '2025-04-01T00:00:00+03:00'),

    -- hr (senior) — 50 000
    ('00000000-0000-4000-8000-000000000301',
     '00000000-0000-4000-8000-000000000020', '00000000-0000-4000-8000-000000000001',
     50000, 0, '2025-Q1', '2025-04-01T00:00:00+03:00'),

    -- ivan (middle) — начислено 50000, потрачено 27000, зарезервировано 18000
    -- balance = 50000 - 27000 - 18000 = 5000, reserved = 18000
    ('00000000-0000-4000-8000-000000000302',
     '00000000-0000-4000-8000-000000000030', '00000000-0000-4000-8000-000000000001',
     5000, 18000, '2025-Q1', '2025-04-01T00:00:00+03:00'),

    -- anna (junior) — 50 000
    ('00000000-0000-4000-8000-000000000303',
     '00000000-0000-4000-8000-000000000031', '00000000-0000-4000-8000-000000000001',
     50000, 0, '2025-Q1', '2025-04-01T00:00:00+03:00'),

    -- dmitry (middle) — 50 000
    ('00000000-0000-4000-8000-000000000304',
     '00000000-0000-4000-8000-000000000032', '00000000-0000-4000-8000-000000000001',
     50000, 0, '2025-Q1', '2025-04-01T00:00:00+03:00'),

    -- elena (senior) — 50 000
    ('00000000-0000-4000-8000-000000000305',
     '00000000-0000-4000-8000-000000000033', '00000000-0000-4000-8000-000000000001',
     50000, 0, '2025-Q1', '2025-04-01T00:00:00+03:00'),

    -- sergey (lead) — 80 000
    ('00000000-0000-4000-8000-000000000306',
     '00000000-0000-4000-8000-000000000034', '00000000-0000-4000-8000-000000000001',
     80000, 0, '2025-Q1', '2025-04-01T00:00:00+03:00'),

    -- maria (director) — 80 000
    ('00000000-0000-4000-8000-000000000307',
     '00000000-0000-4000-8000-000000000035', '00000000-0000-4000-8000-000000000001',
     80000, 0, '2025-Q1', '2025-04-01T00:00:00+03:00')
ON CONFLICT DO NOTHING;


-- =============================================================
-- 10. Заказы для ivan@techfuture.ru
-- =============================================================

-- Заказ 1: Фитнес-клуб годовой — оплачен
INSERT INTO orders (id, user_id, tenant_id, status, total_points, reserved_at, expires_at, created_at) VALUES
    ('00000000-0000-4000-8000-000000000400',
     '00000000-0000-4000-8000-000000000030', '00000000-0000-4000-8000-000000000001',
     'paid', 24000,
     '2025-01-15T10:30:00+03:00',
     '2025-01-15T10:45:00+03:00',
     '2025-01-15T10:30:00+03:00')
ON CONFLICT DO NOTHING;

-- Заказ 2: Курсы английского — зарезервирован
INSERT INTO orders (id, user_id, tenant_id, status, total_points, reserved_at, expires_at, created_at) VALUES
    ('00000000-0000-4000-8000-000000000401',
     '00000000-0000-4000-8000-000000000030', '00000000-0000-4000-8000-000000000001',
     'reserved', 18000,
     '2025-02-20T14:00:00+03:00',
     '2025-02-20T14:15:00+03:00',
     '2025-02-20T14:00:00+03:00')
ON CONFLICT DO NOTHING;

-- Заказ 3: Витамины — оплачен
INSERT INTO orders (id, user_id, tenant_id, status, total_points, reserved_at, expires_at, created_at) VALUES
    ('00000000-0000-4000-8000-000000000402',
     '00000000-0000-4000-8000-000000000030', '00000000-0000-4000-8000-000000000001',
     'paid', 3000,
     '2025-01-22T09:15:00+03:00',
     '2025-01-22T09:30:00+03:00',
     '2025-01-22T09:15:00+03:00')
ON CONFLICT DO NOTHING;


-- =============================================================
-- 11. Позиции заказов (order_items)
-- =============================================================

INSERT INTO order_items (id, order_id, benefit_id, quantity, price_points) VALUES
    -- Заказ 1: Фитнес-клуб
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000400', '00000000-0000-4000-8000-000000000203', 1, 24000),
    -- Заказ 2: Курсы английского
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000401', '00000000-0000-4000-8000-000000000206', 1, 18000),
    -- Заказ 3: Витамины
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000402', '00000000-0000-4000-8000-000000000202', 1, 3000)
ON CONFLICT DO NOTHING;


-- =============================================================
-- 12. Журнал операций с баллами (point_ledger)
-- =============================================================

-- --- Начисления (accrual) для всех кошельков ---

INSERT INTO point_ledger (id, wallet_id, tenant_id, order_id, type, amount, description, created_at) VALUES
    -- admin — начисление 80 000
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000300', '00000000-0000-4000-8000-000000000001',
     NULL, 'accrual', 80000, 'Начисление баллов по политике «Руководительская» за Q1 2025', '2025-01-01T00:00:00+03:00'),

    -- hr — начисление 50 000
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000301', '00000000-0000-4000-8000-000000000001',
     NULL, 'accrual', 50000, 'Начисление баллов по политике «Стандартная» за Q1 2025', '2025-01-01T00:00:00+03:00'),

    -- ivan — начисление 50 000
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000302', '00000000-0000-4000-8000-000000000001',
     NULL, 'accrual', 50000, 'Начисление баллов по политике «Стандартная» за Q1 2025', '2025-01-01T00:00:00+03:00'),

    -- anna — начисление 50 000
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000303', '00000000-0000-4000-8000-000000000001',
     NULL, 'accrual', 50000, 'Начисление баллов по политике «Стандартная» за Q1 2025', '2025-01-01T00:00:00+03:00'),

    -- dmitry — начисление 50 000
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000304', '00000000-0000-4000-8000-000000000001',
     NULL, 'accrual', 50000, 'Начисление баллов по политике «Стандартная» за Q1 2025', '2025-01-01T00:00:00+03:00'),

    -- elena — начисление 50 000
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000305', '00000000-0000-4000-8000-000000000001',
     NULL, 'accrual', 50000, 'Начисление баллов по политике «Стандартная» за Q1 2025', '2025-01-01T00:00:00+03:00'),

    -- sergey — начисление 80 000
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000306', '00000000-0000-4000-8000-000000000001',
     NULL, 'accrual', 80000, 'Начисление баллов по политике «Руководительская» за Q1 2025', '2025-01-01T00:00:00+03:00'),

    -- maria — начисление 80 000
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000307', '00000000-0000-4000-8000-000000000001',
     NULL, 'accrual', 80000, 'Начисление баллов по политике «Руководительская» за Q1 2025', '2025-01-01T00:00:00+03:00')
ON CONFLICT DO NOTHING;

-- --- Списания и резервы для ivan (кошелёк 302) ---

INSERT INTO point_ledger (id, wallet_id, tenant_id, order_id, type, amount, description, created_at) VALUES
    -- Списание за Фитнес-клуб (заказ paid)
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000302', '00000000-0000-4000-8000-000000000001',
     '00000000-0000-4000-8000-000000000400', 'spend', -24000,
     'Оплата заказа: Фитнес-клуб годовой', '2025-01-15T10:30:00+03:00'),

    -- Резерв за Курсы английского (заказ reserved)
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000302', '00000000-0000-4000-8000-000000000001',
     '00000000-0000-4000-8000-000000000401', 'reserve', -18000,
     'Резервирование баллов: Курсы английского', '2025-02-20T14:00:00+03:00'),

    -- Списание за Витамины (заказ paid)
    (gen_random_uuid(), '00000000-0000-4000-8000-000000000302', '00000000-0000-4000-8000-000000000001',
     '00000000-0000-4000-8000-000000000402', 'spend', -3000,
     'Оплата заказа: Витамины и БАД', '2025-01-22T09:15:00+03:00')
ON CONFLICT DO NOTHING;


-- =============================================================
-- 13. Записи аудит-лога
-- =============================================================

INSERT INTO audit_log (id, tenant_id, user_id, action, entity_type, entity_id, diff, created_at) VALUES
    -- HR создала бенефит «ДМС расширенное»
    (gen_random_uuid(),
     '00000000-0000-4000-8000-000000000001',
     '00000000-0000-4000-8000-000000000020',
     'create', 'benefit', '00000000-0000-4000-8000-000000000200',
     '{"name": "ДМС расширенное", "price_points": 30000}'::jsonb,
     '2024-12-20T11:00:00+03:00'),

    -- Иван оформил заказ на Фитнес-клуб
    (gen_random_uuid(),
     '00000000-0000-4000-8000-000000000001',
     '00000000-0000-4000-8000-000000000030',
     'create', 'order', '00000000-0000-4000-8000-000000000400',
     '{"status": "paid", "total_points": 24000, "benefit": "Фитнес-клуб годовой"}'::jsonb,
     '2025-01-15T10:30:00+03:00'),

    -- Иван зарезервировал Курсы английского
    (gen_random_uuid(),
     '00000000-0000-4000-8000-000000000001',
     '00000000-0000-4000-8000-000000000030',
     'create', 'order', '00000000-0000-4000-8000-000000000401',
     '{"status": "reserved", "total_points": 18000, "benefit": "Курсы английского"}'::jsonb,
     '2025-02-20T14:00:00+03:00'),

    -- Иван оплатил Витамины
    (gen_random_uuid(),
     '00000000-0000-4000-8000-000000000001',
     '00000000-0000-4000-8000-000000000030',
     'create', 'order', '00000000-0000-4000-8000-000000000402',
     '{"status": "paid", "total_points": 3000, "benefit": "Витамины и БАД"}'::jsonb,
     '2025-01-22T09:15:00+03:00'),

    -- Admin активировал политику «Руководительская»
    (gen_random_uuid(),
     '00000000-0000-4000-8000-000000000001',
     '00000000-0000-4000-8000-000000000010',
     'create', 'budget_policy', '00000000-0000-4000-8000-000000000501',
     '{"name": "Руководительская", "points_amount": 80000, "period": "quarterly"}'::jsonb,
     '2024-12-25T16:00:00+03:00')
ON CONFLICT DO NOTHING;


-- =============================================================
-- Готово! Seed-данные загружены.
--
-- Сводка по кошельку Ивана Козлова (ivan@techfuture.ru):
--   Начислено:        50 000 баллов (Q1 2025)
--   Потрачено:        27 000 (фитнес 24 000 + витамины 3 000)
--   Зарезервировано:  18 000 (курсы английского)
--   Свободный остаток: 5 000 баллов
-- =============================================================

-- Update real auth users to use new tenant UUID
UPDATE auth.users
SET raw_user_meta_data = raw_user_meta_data || jsonb_build_object('tenant_id', '00000000-0000-4000-8000-000000000001')
WHERE raw_user_meta_data ->> 'tenant_id' IS NOT NULL;

-- Update real app users to new tenant
UPDATE users SET tenant_id = '00000000-0000-4000-8000-000000000001'
WHERE tenant_id NOT IN ('00000000-0000-0000-0000-000000000000', '00000000-0000-4000-8000-000000000001');

-- Update real wallets to new tenant
UPDATE wallets SET tenant_id = '00000000-0000-4000-8000-000000000001'
WHERE tenant_id NOT IN ('00000000-0000-0000-0000-000000000000', '00000000-0000-4000-8000-000000000001');

-- Update trigger function with budget policy balance + correct tenant selection
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER LANGUAGE plpgsql SECURITY DEFINER SET search_path = '' AS $$
DECLARE
  _role public.user_role;
  _tenant_id uuid;
  _user_id uuid;
  _initial_balance int;
BEGIN
  _role := COALESCE((NEW.raw_user_meta_data ->> 'role')::public.user_role, 'employee');

  SELECT id INTO _tenant_id FROM public.tenants
  WHERE id != '00000000-0000-0000-0000-000000000000'
  ORDER BY created_at ASC LIMIT 1;

  IF _tenant_id IS NULL THEN
    INSERT INTO public.tenants (name, domain, settings)
    VALUES ('Default Company', 'default.local', '{}'::jsonb)
    RETURNING id INTO _tenant_id;
  END IF;

  INSERT INTO public.users (id, tenant_id, auth_id, email, role)
  VALUES (gen_random_uuid(), _tenant_id, NEW.id, NEW.email, _role)
  RETURNING id INTO _user_id;

  SELECT COALESCE(bp.points_amount, 0) INTO _initial_balance
  FROM public.budget_policies bp
  WHERE bp.tenant_id = _tenant_id
    AND bp.is_active = true
    AND (bp.target_filter IS NULL OR bp.target_filter = '{}'::jsonb OR bp.target_filter->'match_all' = '[]'::jsonb)
  ORDER BY bp.points_amount ASC LIMIT 1;

  IF _initial_balance IS NULL THEN _initial_balance := 0; END IF;

  INSERT INTO public.wallets (id, user_id, tenant_id, balance, reserved, period, expires_at)
  VALUES (gen_random_uuid(), _user_id, _tenant_id, _initial_balance, 0,
    TO_CHAR(NOW(), 'YYYY') || '-Q' || CEIL(EXTRACT(MONTH FROM NOW()) / 3.0)::int,
    (DATE_TRUNC('quarter', NOW()) + INTERVAL '3 months')::timestamptz);

  UPDATE auth.users
  SET raw_user_meta_data = COALESCE(raw_user_meta_data, '{}'::jsonb)
    || jsonb_build_object('tenant_id', _tenant_id::text)
  WHERE id = NEW.id;

  RETURN NEW;
END; $$;
